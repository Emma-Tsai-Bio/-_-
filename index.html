<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥½æ¼¾äººç”Ÿï½œé›™ä¸­æ¨¡æ“¬å¸‚æ°‘ v6.reset</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --bg:#0b1020;--card:#121933;--line:#22305f;--ink:#e8eeff;--muted:#a8b7e8;
      --ok:#123d2c;--ok2:#1c7c4f;--warn:#3a2b12;--warn2:#996f2a;--bad:#3a1212;--bad2:#912a2a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Arial}
    header{position:sticky;top:0;z-index:4;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);background:#0b1020cc;backdrop-filter:blur(6px)}
    main{padding:12px 12px 110px;max-width:1080px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 12px 24px rgba(0,0,0,.25);overflow:hidden}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}}
    input,select,button,textarea{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid #2a3a78;background:#0f1a3b;color:var(--ink)}
    input,textarea{outline:none}
    button{cursor:pointer}
    .primary{background:#163183;border-color:#2c4fb2}
    .good{background:var(--ok);border-color:var(--ok2)}
    .warn{background:var(--warn);border-color:var(--warn2)}
    .bad{background:var(--bad);border-color:var(--bad2)}
    .badge{border:1px solid #31408a;border-radius:999px;padding:4px 10px;color:#cdd8ff;font-size:12px}
    .pill{padding:4px 10px;border-radius:999px;background:#0e1630;border:1px solid #1d2a63;color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse;table-layout:auto}
    .table th,.table td{border-bottom:1px solid var(--line);padding:6px 4px;text-align:left;font-size:13px;white-space:nowrap}
    .hidden{display:none}
    .right{text-align:right}
    .note{color:var(--muted);font-size:12px}
    .bar{height:10px;border-radius:999px;background:#0e1630;border:1px solid #1d2a63;overflow:hidden;min-width:160px}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#3b82f6,#60a5fa);width:100%}
    .sticky{position:fixed;bottom:0;left:0;right:0;background:#0b1020f2;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:space-around;padding:8px;z-index:9}
    .scroll-table{max-height:260px;overflow-y:auto;overflow-x:auto}
    .h4{font-size:16px;margin:0 0 6px}
    .dash{display:flex;gap:10px;flex-wrap:wrap}
    .dash .box{background:#0f1a3b;border:1px solid #2a3a78;border-radius:12px;padding:10px 12px;min-width:120px}
    .dash .box b{font-size:18px}
    .fab{position:fixed;right:16px;bottom:72px;z-index:5;padding:12px 16px;border-radius:999px;background:#1e3a8a;border:1px solid #3b82f6;color:#fff;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .swal2-html-container{text-align:center !important;}
    #tAmt,#tE,#tM{width:90px}
  </style>
</head>
<body>

<header>
  <div class="row">
    <strong>å¥½æ¼¾äººç”Ÿï½œé›™ä¸­æ¨¡æ“¬å¸‚æ°‘</strong>
    <span id="who" class="badge">æœªç™»å…¥</span>
  </div>
  <div class="row">
    <button id="btnSound" class="pill">ğŸ”ˆ æç¤ºéŸ³é–‹</button>
  </div>
</header>

<main id="main">

  <!-- ğŸ“‡ å°é¢ -->
  <section id="page-cover" class="card">
    <h3>ğŸ“‡ å°é¢</h3>
    <div class="grid-2">
      <div class="card">
        <div class="row">
          <label>ç­ç´š</label><input id="klass" autocomplete="off" placeholder="901">
          <label>åº§è™Ÿ</label><input id="no" autocomplete="off" placeholder="12">
          <label>å§“å</label><input id="name" autocomplete="off" placeholder="ç‹å°æ˜" style="min-width:140px">
        </div>
        <div class="row">
          <label>è·æ¥­</label>
          <select id="job"></select>
        </div>
        <div id="jobDesc" class="note">
          è«‹é¸æ“‡è·æ¥­ï¼Œå³å´æœƒé¡¯ç¤ºå·¥ä½œå…§å®¹ã€è–ªè³‡ã€é«”åŠ›ï¼å¿ƒæƒ…è€—æã€æœ‰è–ªå‡å¤©æ•¸ã€‚
        </div>
        <div class="row" style="margin-top:8px">
          <button id="start" class="primary">å„²å­˜ä¸¦é–‹å§‹ï¼ˆDay1ï¼‰</button>
          <button id="seeRules" class="warn">æŸ¥çœ‹è¦å‰‡</button>
        </div>
      </div>
      <div class="card">
        <div class="row"><span class="pill">å­¸ç”Ÿè­˜åˆ¥</span><span id="sid" class="badge">å°šæœªå»ºç«‹</span></div>
        <div class="row"><span class="pill">å·²é¸è·æ¥­</span><span id="jobNow" class="badge">â€”</span></div>
        <div class="row">
          <span class="pill">èµ·å§‹é‡‘éŒ¢</span>
          <div class="bar"><span style="width:100%"></span></div>
          <span class="pill" id="startMoney">1000</span>
        </div>
        <div class="row">
          <span class="pill">é«”åŠ›</span>
          <div class="bar"><span id="eBar"></span></div>
          <span id="eVal" class="pill">100</span>
        </div>
        <div class="row">
          <span class="pill">å¿ƒæƒ…</span>
          <div class="bar"><span id="mBar"></span></div>
          <span id="mVal" class="pill">100</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ¯ è¦å‰‡èªªæ˜é  -->
  <section id="page-rules" class="card hidden">
    <h2>ğŸ¯ éŠæˆ²ä»»å‹™èªªæ˜</h2>
    <p>
      ä½ å³å°‡é«”é©— 4 å¤©çš„ã€Šå¥½æ¼¾äººç”Ÿæ¨¡æ“¬å¸‚æ°‘ã€‹ï¼<br>
      ä½ çš„ç›®æ¨™æ˜¯ï¼š<strong>è®“é‡‘éŒ¢ ğŸ’µã€é«”åŠ› â¤ï¸ã€å¿ƒæƒ… ğŸ˜Š éƒ½ç¶­æŒå¹³è¡¡</strong>ã€‚<br><br>
      ğŸ’€ ä»»ä¸€æ•¸å€¼è®Šæˆ 0 å°±æœƒã€Œæ­»äº¡é‡ç”Ÿã€ï¼Œæœƒè¢«è¨˜éŒ„æ­»äº¡æ¬¡æ•¸ã€‚<br>
      ğŸ† éŠæˆ²çµæŸå¾Œæœƒæ ¹æ“šä¸‰å€‹æ•¸å€¼æ›ç®—æˆæœ€çµ‚æˆæœï¼Œèª°èƒ½æ´»å¾—æœ€å¹³è¡¡ã€æœ€è°æ˜å‘¢ï¼Ÿ
    </p>

    <h3>ğŸ§© åŸºæœ¬ç©æ³•</h3>
    <ul>
      <li>ğŸ’µ <strong>è³ºéŒ¢</strong>ï¼šä¸»è¦é å·¥ä½œã€æŠ•è³‡ã€‚</li>
      <li>â¤ï¸ <strong>é«”åŠ›</strong>ï¼šæ¯å¤©è‡³å°‘åƒ 1 é¤ï¼Œåƒé£¯å¯è£œé«”åŠ›ã€‚</li>
      <li>ğŸ˜Š <strong>å¿ƒæƒ…</strong>ï¼šé€éä¼‘é–’æ´»å‹•ç¶­æŒé–‹å¿ƒï¼</li>
      <li>ğŸ² <strong>Day1ã€3</strong>ï¼šå¯ä»¥æŠ½ã€Œå‘½é‹äº‹ä»¶å¡ã€ï¼Œå¯èƒ½å¥½é‹ã€ä¹Ÿå¯èƒ½å€’æ¥£ï¼</li>
      <li>ğŸ’¸ <strong>Day2ã€4</strong>ï¼šæœ‰å¼·åˆ¶æ”¯å‡ºï¼ˆç¹³ç­è²»ã€æ°´é›»è²»ï¼‰è¦è¨˜å¾—ç•™éŒ¢ï¼</li>
      <li>â˜ ï¸ ä»»ä¸€æ•¸å€¼æ­¸ 0 æœƒæ­»äº¡é‡ç”Ÿï¼Œè¨˜éŒ„ +1ã€‚</li>
    </ul>

    <div class="card">
      <b>é«”åŠ›å€¼ã€å¿ƒæƒ…å€¼è¦å‰‡èˆ‡å½±éŸ¿ï¼ˆç³»çµ±æœƒè‡ªå‹•å¥—ç”¨åˆ°è–ªæ°´è¨ˆç®—ï¼‰</b>
      <ul>
        <li>é«”åŠ› &gt; 110ï¼šè–ªæ°´ 1.5 å€</li>
        <li>é«”åŠ› &lt; 50ï¼šè–ªæ°´æ¸›åŠ</li>
        <li>å¿ƒæƒ… &gt; 110ï¼šè–ªæ°´ 1.5 å€</li>
        <li>å¿ƒæƒ… &lt; 30ï¼šè–ªæ°´æ¸›åŠ</li>
      </ul>
      <p class="note">ï¼Šå¯¦éš›ç™¼æ”¾ç©å…·éˆ”æ™‚ï¼Œè€å¸«ä¹Ÿå¯ä»¥åƒè€ƒæ­¤å€ç‡ã€‚</p>
    </div>

    <button id="toRecord" class="primary">å»è¨˜å¸³ â–¶</button>
  </section>

  <!-- ğŸ§¾ è¨˜å¸³é  -->
  <section id="page-record" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h3>ğŸ§¾ è¨˜å¸³ï¼ˆç¬¬ <span id="day">1</span> å¤©ï¼‰</h3>
      <span class="pill">ç³»çµ±æœƒåœ¨å¾Œå°è‡ªå‹•è¨ˆç®—ï¼Œä½†ä¸æœƒå³æ™‚é¡¯ç¤ºçµæœ</span>
    </div>

    <!-- ç›®å‰è·æ¥­è³‡è¨Š -->
    <div id="jobBanner" class="card" style="margin-top:8px;margin-bottom:12px;">
      <div class="note">ç›®å‰å°šæœªé¸æ“‡è·æ¥­ï¼Œè«‹å…ˆå›åˆ°ã€Œå°é¢ã€é é¸è·æ¥­ã€‚</div>
    </div>

    <!-- ğŸŒ… æ¯æ—¥æç¤º -->
    <div id="alerts" class="card">
      <h3>ğŸŒ… æ–°çš„ä¸€å¤©é–‹å§‹ï¼</h3>
      <p>
        ä»Šå¤©è«‹å®Œæˆä»¥ä¸‹äº‹æƒ… ğŸ‘‡<br>
        â‘  åšä½ çš„å·¥ä½œï¼ˆæˆ–è«‹å‡ï¼‰â†’ è³ºéŒ¢ä¸»è¦ä¾†æºã€‚<br>
        â‘¡ é¸æ“‡åƒé£¯ 1ï½3 æ¬¡ â†’ è£œé«”åŠ›ã€‚<br>
        â‘¢ åš 1ï½2 å€‹ä¼‘é–’æ´»å‹• â†’ åŠ å¿ƒæƒ…ã€‚<br>
        â‘£ è‹¥æ˜¯ Day1 æˆ– Day3 â†’ å¯æŠ½å‘½é‹äº‹ä»¶å¡ï¼<br>
        â‘¤ æ³¨æ„ï¼Day2ã€Day4 æœƒæœ‰å¼·åˆ¶èŠ±è²»ï¼Œè¨˜å¾—é ç•™ç¾é‡‘ã€‚ğŸ’¸
      </p>
    </div>

    <!-- å¿«æ·éµ -->
    <div class="card">
      <div class="grid-2">
        <!-- å·¦ï¼šå·¥ä½œï¼‹è«‹å‡ï¼‹ä¼‘é–’ -->
        <div>
          <div class="h4">ğŸ’¼ å·¥ä½œèˆ‡è«‹å‡</div>
          <div class="row">
            <button id="work" class="primary">å®Œæˆå·¥ä½œï¼ˆæ•™å¸«èªè­‰ï¼‰</button>
            <button id="giftBtn" class="good hidden">ç²‰çµ²è´ˆç¦®ï¼ˆå¤§ç¶²ç´…ï¼‰</button>
          </div>
          <div class="row">
            <button id="leavePaid" class="good">è«‹æœ‰è–ªå‡</button>
            <button id="leaveUnpaid" class="warn">è«‹ç„¡è–ªå‡</button>
          </div>
          <p class="note">
            ï¼Šè«‹å‡å¾Œï¼Œä¼‘é–’æ´»å‹•æ¬¡æ•¸ä¸é™ï¼›æœ‰è–ªå‡ä»å¯é ˜è–ªæ°´ï¼Œç„¡è–ªå‡å‰‡æ²’æœ‰è–ªæ°´ã€‚<br>
            ï¼Šæœ‰è–ªå‡èˆ‡ç„¡è–ªå‡éœ€è‡ªè¡Œåœ¨è¨˜å¸³é¢æ¿å¡«å¯«é‡‘éŒ¢ã€é«”åŠ›ã€å¿ƒæƒ…è®ŠåŒ–ã€‚
          </p>

          <hr>

          <div class="h4">ğŸ® ä¼‘é–’æ´»å‹•ï¼ˆæ¯æ—¥æœ€å¤š 2 æ¬¡ï¼Œå¦‚ç•¶å¤©è«‹å‡å‰‡ç„¡ä¸Šé™ï¼‰</div>
          <p class="note">
            ğŸ² æ¯å¤©æœ€å¤šç© 2 å€‹æ´»å‹•ï¼ˆè«‹å‡å¯ç©ä¸é™æ¬¡ï¼‰ã€‚<br>
            ğŸ’¬ å¤ªå¤šå¨›æ¨‚ä¹Ÿæœƒç´¯ï¼Œåˆ¥è®“é«”åŠ›çˆ†æ‰å–”ï¼
          </p>
          <div class="row">
            <button id="fun0" class="good">çœ‹é›»å½±ï¼ˆéŒ¢-200 / é«”-10 / å¿ƒ+20ï¼‰</button>
            <button id="fun1" class="good">æ‰“é›»å‹•ï¼ˆéŒ¢-50 / é«”-10 / å¿ƒ+15ï¼‰</button>
            <button id="fun2" class="good">èšé¤ï¼ˆéŒ¢-250 / é«”-10 / å¿ƒ+25ï¼‰</button>
            <button id="fun3" class="good">é‹å‹•ï¼ˆéŒ¢-10 / é«”-25 / å¿ƒ+15ï¼‰</button>
            <button id="fun4" class="good">ç•«ç•«ï¼è®€æ›¸ï¼ˆéŒ¢-100 / é«”-5 / å¿ƒ+10ï¼‰</button>
          </div>
        </div>

        <!-- å³ï¼šé¤é£Ÿï¼‹æŠ½å¡ -->
        <div>
          <div class="h4">ğŸ± é¤é£Ÿï¼ˆæ¯æ—¥æœ€å¤š 3 æ¬¡ï¼‰</div>
          <p class="note">
            ğŸ’¡ æ¯å¤©è‡³å°‘åƒä¸€é¤ï¼Œä¸åƒæœƒæ‰é«”åŠ›åˆæ‰å¿ƒæƒ…ï¼<br>
            ğŸ§‘â€ğŸ³ è‡ªå·±ç…®è¦èŠ±æ™‚é–“ï¼ˆæœƒå  1 å€‹ä¼‘é–’æ ¼ï¼‰ï¼Œä½†æœ€å‡è¡¡åˆçœéŒ¢ã€‚
          </p>
          <div class="row">
            <button id="food0" class="warn">ä¸åƒé£¯ï¼ˆéŒ¢0 / é«”-20 / å¿ƒ-15ï¼‰</button>
            <button id="food1" class="warn">è‡ªå·±å‚™é¤ï¼ˆéŒ¢-100 / é«”+20 / å¿ƒ+10ï¼‰</button>
            <button id="food2" class="warn">è·¯é‚Šæ”¤ï¼ˆéŒ¢-100 / é«”+15 / å¿ƒ+10ï¼‰</button>
            <button id="food3" class="warn">å¥åº·é¤ç›’ï¼ˆéŒ¢-200 / é«”+30 / å¿ƒ+0ï¼‰</button>
            <button id="food4" class="warn">å¥¢ä¾ˆé€Ÿé£Ÿï¼ˆéŒ¢-300 / é«”+10 / å¿ƒ+20ï¼‰</button>
          </div>

          <div id="drawBlock" style="margin-top:12px">
            <div class="h4">ğŸ² å‘½é‹äº‹ä»¶å¡ï¼ˆDay1ã€Day3ï¼Œæ¯æ—¥æœ€å¤š 2 æ¬¡ï¼‰</div>
            <div class="row">
              <button id="btnDraw" class="primary">æŠ½äº‹ä»¶å¡ï¼ˆå¹¸é‹ï¼ä¸å¹¸ï¼‰</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¨˜å¸³èˆ‡æ˜ç´° -->
    <div class="card">
      <div class="h4">ğŸ§¾ è¨˜å¸³èˆ‡ä»Šæ—¥æ˜ç´°</div>
      <div id="jobRule" class="note" style="margin-bottom:6px;">è·æ¥­ï¼šâ€”</div>
      <div class="grid-2">
        <div>
          <div class="row">
            <label>æ”¶ï¼æ”¯</label>
            <select id="tType">
              <option value="income">æ”¶å…¥</option>
              <option value="expense">æ”¯å‡º</option>
            </select>
            <label>é¡åˆ¥</label>
            <select id="tCat">
              <option value="salary">è–ªè³‡ï¼æ‰“å·¥</option>
              <option value="food">é¤é£Ÿ</option>
              <option value="leisure">ä¼‘é–’</option>
              <option value="bank">éŠ€è¡Œï¼åˆ©æ¯</option>
              <option value="loan">å€Ÿæ¬¾ï¼é‚„æ¬¾</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          <div class="row">
            <label>é‡‘é¡</label>
            <input id="tAmt" type="number" placeholder="å¯ç‚º 0">
            <label>é«”åŠ›è®ŠåŒ–</label>
            <input id="tE" type="number" placeholder="-10 æˆ– 20">
            <label>å¿ƒæƒ…è®ŠåŒ–</label>
            <input id="tM" type="number" placeholder="+15 æˆ– -5">
          </div>
          <div class="row">
            <label>å‚™è¨»</label>
            <input id="tNote" style="flex:1" placeholder="ä¾‹å¦‚ï¼šçœ‹é›»å½±ï¼ç¹³ç­è²»">
            <button id="add" class="primary">åŠ å…¥æœ¬æ—¥</button>
          </div>
          <p class="note">ï¼Šä¸‹æ–¹å„€è¡¨æ¿èˆ‡é«”ï¼å¿ƒæ•¸å€¼ä»¥ã€Œå­¸ç”Ÿè‡ªè¡Œè¼¸å…¥ã€ç‚ºæº–ï¼Œèˆ‡ç³»çµ±å¾Œå°å¯èƒ½ä¸åŒã€‚</p>
          <div class="dash">
            <div class="box">ç›®å‰é‡‘éŒ¢<br><b id="dashMoney">1000</b></div>
            <div class="box">ç›®å‰é«”åŠ›<br><b id="dashE">100</b></div>
            <div class="box">ç›®å‰å¿ƒæƒ…<br><b id="dashM">100</b></div>
          </div>
        </div>
        <div>
          <div class="scroll-table">
            <table class="table" id="tTable">
              <thead>
              <tr><th>æ—¥æœŸ</th><th>æ”¶ï¼æ”¯</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>é«”</th><th>å¿ƒ</th><th>å‚™è¨»</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="row"><button id="clear" class="warn">æ¸…ç©ºä»Šæ—¥</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ çµç®—é  -->
  <section id="page-summary" class="card hidden">
    <h3>ğŸ‰ æ­å–œå®Œæˆ 4 å¤©æŒ‘æˆ°ï¼</h3>
    <p>
      ä¾†çœ‹çœ‹ä½ çš„äººç”Ÿéå¾—å¦‚ä½•å§ï¼š<br>
      ğŸ’µ éŒ¢å¤ ç”¨å—ï¼Ÿ â¤ï¸ é›™è…³æ’å¾—ä½å—ï¼Ÿ ğŸ˜Š é‚„å¿«æ¨‚å—ï¼Ÿ<br><br>
      ğŸ’€ æ­»äº¡æœƒæ‰£åˆ†ï¼Œæ¬ å‚µæœƒæ¸›åˆ†ã€‚<br>
      ğŸ§˜â€â™‚ï¸ ä¸‰å€¼éƒ½ç©©åˆæ²’æ¬ å‚µ = <strong>äººç”Ÿå¹³è¡¡ç‹ï¼</strong><br><br>
      å®Œæˆå¾Œè«‹é»ã€Œé€äº¤åˆ°è¡¨å–®ã€ï¼Œä¸¦å›ç­”åæ€å•é¡Œã€‚
    </p>

    <div class="grid-2">
      <div class="card">
        <h4 class="h4">ç³»çµ±å¾Œå°è¨ˆç®—</h4>
        <div class="row">
          <span class="pill">é‡‘ï¼š<span id="smMoney">0</span></span>
          <span class="pill">é«”ï¼š<span id="smE">0</span></span>
          <span class="pill">å¿ƒï¼š<span id="smM">0</span></span>
          <span class="pill">æ­»ï¼š<span id="smD">0</span></span>
        </div>
      </div>
      <div class="card">
        <h4 class="h4">å­¸ç”Ÿè‡ªè¡Œè¨˜å¸³</h4>
        <div class="row">
          <span class="pill">é‡‘ï¼š<span id="stMoney">0</span></span>
          <span class="pill">é«”ï¼š<span id="stE">0</span></span>
          <span class="pill">å¿ƒï¼š<span id="stM">0</span></span>
          <span class="pill">æ­»ï¼š<span id="stD">0</span></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h4 class="h4">ğŸ“ èª¤å·®åˆ†æ</h4>
      <div id="delta" class="note">â€”</div>
    </div>

    <div class="grid-2">
      <div class="card">
        <h4 class="h4">ğŸ§® ç³»çµ±æ˜ç´°ï¼ˆå¾Œå°ç´€éŒ„ï¼‰</h4>
        <div class="scroll-table">
          <table class="table" id="sysTable">
            <thead>
            <tr><th>æ—¥</th><th>æ”¶ï¼æ”¯</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>é«”</th><th>å¿ƒ</th><th>å‚™è¨»</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h4 class="h4">âœ å­¸ç”Ÿè¨˜å¸³æ˜ç´°</h4>
        <div class="scroll-table">
          <table class="table" id="stuTable">
            <thead>
            <tr><th>æ—¥</th><th>æ”¶ï¼æ”¯</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>é«”</th><th>å¿ƒ</th><th>å‚™è¨»</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="row">
      <button id="copy" class="good">è¤‡è£½ JSON</button>
      <button id="sendEnd" class="primary">é€äº¤åˆ°è¡¨å–®</button>
    </div>
  </section>

  <!-- ğŸ‘©â€ğŸ« æ•™å¸«ç«¯ -->
  <section id="page-teacher" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h3>ğŸ‘©â€ğŸ« æ•™å¸«å·¥å…·</h3>
      <div class="row">
        <input id="tpw" autocomplete="off" placeholder="æ•™å¸«ç¢¼" style="width:150px">
        <button id="tun" class="primary">è§£é–</button>
      </div>
    </div>

    <div id="tTools" class="hidden">
      <div class="card">
        <h4 class="h4">ğŸ“¨ è¡¨å–®è¨­å®š</h4>
        <p class="note">è²¼ Google è¡¨å–® formResponse çš„ç¶²å€å‰æ®µï¼ˆå« entry= ç­‰è™Ÿï¼‰ï¼Œå­¸ç”ŸæŒ‰ã€Œé€äº¤åˆ°è¡¨å–®ã€æ™‚æœƒæŠŠ JSON æ¥åœ¨å¾Œé¢ã€‚</p>
        <div class="row">
          <input id="formURL" autocomplete="off" style="flex:1">
          <button id="saveForm" class="primary">å„²å­˜</button>
          <span id="formSaved" class="pill">â€”</span>
        </div>
      </div>

      <div class="card">
        <h4 class="h4">ğŸ§© åŒ¯ç¸½å­¸ç”Ÿå¿«ç…§</h4>
        <textarea id="agg" style="width:100%;min-height:140px" placeholder='{"key":"901-12-ç‹å°æ˜","day":4,"system":{"money":1200,"energy":80,"mood":90,"deaths":0},"student":{"money":1100,"energy":70,"mood":85,"deaths":1}}'></textarea>
        <div class="row">
          <button id="parse" class="primary">è§£æ</button>
          <button id="csvAll" class="good">ä¸‹è¼‰å…¨ç­ CSV</button>
        </div>
        <div class="scroll-table">
          <table class="table" id="aggT">
            <thead>
            <tr>
              <th>å­¸ç”Ÿ</th><th>å¤©æ•¸</th>
              <th>sys é‡‘</th><th>stu é‡‘</th>
              <th>sys é«”</th><th>stu é«”</th>
              <th>sys å¿ƒ</th><th>stu å¿ƒ</th>
              <th>sys æ­»</th><th>stu æ­»</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ä¸‹æ–¹å°è¦½ -->
<div class="sticky">
  <button data-nav="#page-cover">å°é¢</button>
  <button data-nav="#page-rules">è¦å‰‡</button>
  <button data-nav="#page-record">è¨˜å¸³</button>
  <button data-nav="#page-summary">çµç®—</button>
  <button data-nav="#page-teacher">æ•™å¸«</button>
</div>

<!-- çµæŸä»Šå¤© -->
<button id="endDay" class="fab">çµæŸä»Šå¤© â–¶</button>

<script>
(function(){
  function $(s){return document.querySelector(s)}
  function $$(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
  var PFX="hy-young-v60";
  var TEACHER="127";

  // ä¸€é€²ä¾†å°±æ¸…æ‰ä¹‹å‰æ‰€æœ‰é€™å€‹éŠæˆ²çš„è¨˜éŒ„ï¼ˆåªæ¸…æœ¬éŠæˆ²å‰ç¶´ï¼‰
  (function clearOldStorage(){
    try{
      var toDel = [];
      for(var i=0;i<localStorage.length;i++){
        var k = localStorage.key(i);
        if(k.indexOf(PFX+':') === 0){
          toDel.push(k);
        }
      }
      toDel.forEach(function(k){ localStorage.removeItem(k); });
    }catch(e){}
  })();

  // ğŸ”Š éŸ³æ•ˆ
  var audio=null,soundOn=true;
  function ainit(){if(!audio){try{audio=new (window.AudioContext||window.webkitAudioContext)()}catch(e){}}}
  function beep(k){
    if(!soundOn)return;
    ainit();if(!audio)return;
    var o=audio.createOscillator(),g=audio.createGain();
    o.connect(g);g.connect(audio.destination);
    var t=audio.currentTime;var f=700,d=.12;
    if(k==='start')f=520;
    if(k==='card')f=760;
    if(k==='warn')f=240;
    if(k==='dead')f=160;
    if(k==='ding')f=1200;
    if(k==='cash')f=500;
    o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(.0001,t);
    g.gain.exponentialRampToValueAtTime(.2,t+.02);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.start(t);o.stop(t+d+.02);
  }
  $('#btnSound').onclick=function(){
    soundOn=!soundOn;
    $('#btnSound').textContent=soundOn?'ğŸ”ˆ æç¤ºéŸ³é–‹':'ğŸ”‡ æç¤ºéŸ³é—œ';
  };

  function alertInfo(html){Swal.fire({icon:"info",html:html,confirmButtonText:"å¥½"});}
  function alertSuccess(html){Swal.fire({icon:"success",html:html,confirmButtonText:"å¤ªæ£’äº†ï¼"});}
  function alertWarn(html){Swal.fire({icon:"warning",html:html,confirmButtonText:"æˆ‘çŸ¥é“äº†"});}
  function alertError(html){Swal.fire({icon:"error",html:html,confirmButtonText:"å¥½"});}

  // è·æ¥­
  var JOBS=[
    {id:'mega',name:'é»‘ç´…å¤§ç¶²ç´…ï¼ˆæœ‰è–ªå‡0å¤©ï¼‰',salary:600,e:-60,m:-50,pl:0,
      desc:'æ¯å¤©éŒ„å½±ç´€éŒ„1ç¨®è·æ¥­å…§å®¹ï¼Œä¸¦ç”¢å‡ºä»‹ç´¹æ–‡å­—ã€æ¨™é¡Œã€‚å·¥ä½œå®Œæˆå¾Œï¼Œå¯èƒ½è§¸ç™¼ç²‰çµ²è´ˆç¦®ã€‚è–ªè³‡ï¼šå®Œæˆ +600ï¼›é«”åŠ›-60ï¼›å¿ƒæƒ…-50ã€‚'},
    {id:'eng',name:'å·¥ç¨‹å¸«',salary:500,e:-50,m:-40,pl:1,base:150,bonus:350,
      desc:'æ¯å¤©å®Œæˆä¸€å€‹ç¨‹å¼ã€‚è–ªè³‡ï¼šåº•è–ª150ï¼‹å®Œæˆçé‡‘350ï¼ˆå…±500ï¼‰ï¼›é«”åŠ›-50ï¼›å¿ƒæƒ…-40ã€‚'},
    {id:'teacher',name:'è€å¸«',salary:300,e:-20,m:-40,pl:1,
      desc:'æ¯å¤©å®Œæˆä¸€å€‹é¡Œç›®è¬›è§£æˆ–é‡é»ç­†è¨˜æ•´ç†ã€‚è–ªè³‡ï¼š+300ï¼›é«”åŠ›-20ï¼›å¿ƒæƒ…-40ã€‚'},
    {id:'admin',name:'è¡Œæ”¿äººå“¡',salary:150,e:-15,m:-20,pl:1,
      desc:'æ‰“å­—ï¼ˆå­¸ç§‘é‡é»ï¼‰ã€‚è–ªè³‡ï¼š+150ï¼›é«”åŠ›-15ï¼›å¿ƒæƒ…-20ã€‚'},
    {id:'clean',name:'æ¸…æ½”äººå“¡',salary:100,e:-30,m:-30,pl:1,
      desc:'æƒæ•™å®¤ã€æ“¦çª—æˆ¶ã€æ•´ç†å›æ”¶ç‰©â‹¯â‹¯ã€‚è–ªè³‡ï¼š+100ï¼›é«”åŠ›-30ï¼›å¿ƒæƒ…-30ã€‚'},
    {id:'mini',name:'å°ç¶²ç´…ï¼ˆæœ‰è–ªå‡0å¤©ï¼‰',salary:80,e:-40,m:+30,pl:0,
      desc:'æ‹1å¼µåˆæ ¼æ´»å‹•ç…§ç‰‡ï¼‹æ‹æŠ–éŸ³éŸ³æ¨‚èˆã€‚è–ªè³‡ï¼š+80ï¼›é«”åŠ›-40ï¼›å¿ƒæƒ…+30ã€‚'}
  ];

  var LUCKY=[
    {name:'æ’¿åˆ°éŒ¢åŒ…ä¸¦æ­¸é‚„',amt:+100,e:0,m:+10},
    {name:'æŠ½ä¸­å•†å“ç¦®åˆ¸',amt:+200,e:0,m:+15},
    {name:'èšé¤æœ‹å‹è«‹å®¢',amt:0,e:0,m:+20},
    {name:'æŠ½åˆ°å…è²»æ—…éŠåˆ¸',amt:0,e:+10,m:+30}
  ];
  var UNLUCKY=[
    {name:'ä¸‹å¤§é›¨æ²’å¸¶å‚˜',amt:-100,e:-10,m:-10},
    {name:'æ„Ÿå†’éœ€è¦çœ‹é†«ç”Ÿ',amt:-200,e:-20,m:-10},
    {name:'æ‰‹æ©Ÿå£æ‰ç¶­ä¿®',amt:-300,e:0,m:-20},
    {name:'é‘°åŒ™ä¸è¦‹æ‰¾é–åŒ ',amt:-200,e:-5,m:-10},
    {name:'é¨è…³è¸è»Šé—–ç´…ç‡ˆ',amt:-300,e:0,m:-20},
    {name:'ä¸å°å¿ƒå—å‚·ä½é™¢',amt:-400,e:-20,m:-20}
  ];

  var S={
    meta:{klass:'',no:'',name:'',day:1},
    job:null,
    tx_stu:{1:[],2:[],3:[],4:[]},
    tx_sys:{1:[],2:[],3:[],4:[]},
    formURL:'',
    effects:{},
    counters:{},
    leave:{},
    leavePaidUsed:0,
    deathCount:0,
    deathDays:[]
  };

  // å¤§ç¶²ç´…ç²‰çµ²ç¦®ç‰©æ¯æ—¥ä½¿ç”¨ç‹€æ…‹
  var giftUsed={1:false,2:false,3:false,4:false};
  // æ¯æ—¥æ˜¯å¦å·²å®Œæˆå·¥ä½œ
  var workUsed={1:false,2:false,3:false,4:false};

  function key(){return PFX+":"+(S.meta.klass||'NA')+"-"+(S.meta.no||'NA')+"-"+(S.meta.name||'NA');}
  function save(){try{localStorage.setItem(key(),JSON.stringify(S));}catch(e){}}

  function nav(id){
    var secs=$$('main>section');
    for(var i=0;i<secs.length;i++){secs[i].classList.toggle('hidden','#'+secs[i].id!==id);}
    location.hash=id;
  }
  function setBars(e,m){
    $('#eBar').style.width=Math.max(0,Math.min(100,e))+'%';
    $('#mBar').style.width=Math.max(0,Math.min(100,m))+'%';
    $('#eVal').textContent=Math.round(e);
    $('#mVal').textContent=Math.round(m);
  }
  function fmtSign(v){if(v===undefined||v===null)return'';return v>=0?('+'+v):v;}
  function transCat(c){
    var map={salary:'è–ªè³‡ï¼æ‰“å·¥',food:'é¤é£Ÿ',leisure:'ä¼‘é–’',bank:'éŠ€è¡Œï¼åˆ©æ¯',loan:'å€Ÿæ¬¾ï¼é‚„æ¬¾',event:'äº‹ä»¶',other:'å…¶ä»–'};
    return map[c]||c;
  }

  // è·æ¥­é¸å–®
  var jobSel=$('#job');
  jobSel.innerHTML='<option value="">â€” è«‹é¸æ“‡ â€”</option>'+JOBS.map(function(j){return'<option value="'+j.id+'">'+j.name+'</option>';}).join('');
  function renderJobBanner(){
    if(!S.job){
      $('#jobBanner').innerHTML='<div class="note">ç›®å‰å°šæœªé¸æ“‡è·æ¥­ï¼Œè«‹å…ˆå›åˆ°ã€Œå°é¢ã€é é¸è·æ¥­ã€‚</div>';
      return;
    }
    $('#jobBanner').innerHTML=
      '<div class="row"><span class="pill">ç›®å‰è·æ¥­</span><b>'+S.job.name+'</b></div>'+
      '<div class="row">'+
        '<span class="pill">æ¯æ¬¡å®Œæˆå·¥ä½œï¼šç´„ $'+S.job.salary+'</span>'+
        '<span class="pill">é«”åŠ› '+S.job.e+'</span>'+
        '<span class="pill">å¿ƒæƒ… '+S.job.m+'</span>'+
        '<span class="pill">æœ‰è–ªå‡ '+S.job.pl+' å¤©</span>'+
      '</div>';
  }
  function paintJobDesc(){
    if(!S.job){
      $('#jobNow').textContent='â€”';
      $('#jobDesc').textContent='è«‹é¸æ“‡è·æ¥­ï¼Œå³å´æœƒé¡¯ç¤ºå·¥ä½œå…§å®¹ã€è–ªè³‡ã€é«”åŠ›ï¼å¿ƒæƒ…è€—æã€æœ‰è–ªå‡å¤©æ•¸ã€‚';
      $('#jobRule').textContent='è·æ¥­ï¼šâ€”';
      $('#giftBtn').classList.add('hidden');
      renderJobBanner();
      return;
    }
    $('#jobNow').textContent=S.job.name;
    if(S.job.id==='mega')$('#giftBtn').classList.remove('hidden');else $('#giftBtn').classList.add('hidden');
    $('#jobDesc').innerHTML='<div class="pill">å·¥ä½œå…§å®¹ï¼š'+S.job.desc+'</div>'
      +'<div class="pill">æ¯æ¬¡å®Œæˆè–ªè³‡ï¼šç´„ $'+S.job.salary+'</div>'
      +'<div class="pill">é«”åŠ›è®ŠåŒ–ï¼š'+S.job.e+'</div>'
      +'<div class="pill">å¿ƒæƒ…è®ŠåŒ–ï¼š'+S.job.m+'</div>'
      +'<div class="pill">æœ‰è–ªå‡å¤©æ•¸ï¼š'+S.job.pl+'</div>';
    $('#jobRule').innerHTML='è·æ¥­ï¼š<b>'+S.job.name+'</b> ï½œ æ¯æ¬¡å®Œæˆå·¥ä½œï¼š<b>ç´„ $'+S.job.salary+'</b> ï½œ é«”åŠ› '+S.job.e+' ï½œ å¿ƒæƒ… '+S.job.m+' ï½œ æœ‰è–ªå‡å¤©æ•¸ï¼š'+S.job.pl;
    renderJobBanner();
  }
  jobSel.onchange=function(){
    var id=jobSel.value;S.job=null;
    for(var i=0;i<JOBS.length;i++){if(JOBS[i].id===id){S.job=JOBS[i];break;}}
    paintJobDesc();save();
  };

  var started=false;
  $('#start').onclick=function(){
    S.meta.klass=$('#klass').value.trim();
    S.meta.no=$('#no').value.trim();
    S.meta.name=$('#name').value.trim();
    S.meta.day=1;
    S.tx_stu={1:[],2:[],3:[],4:[]};
    S.tx_sys={1:[],2:[],3:[],4:[]};
    S.counters={1:{food:0,fun:0,draw:0},2:{food:0,fun:0,draw:0},3:{food:0,fun:0,draw:0},4:{food:0,fun:0,draw:0}};
    S.leave={};
    S.leavePaidUsed=0;
    S.deathCount=0;
    S.deathDays=[];
    giftUsed={1:false,2:false,3:false,4:false};
    workUsed={1:false,2:false,3:false,4:false};

    $('#who').textContent=S.meta.name?(S.meta.klass+"-"+S.meta.no+"-"+S.meta.name):'æœªç™»å…¥';
    $('#sid').textContent=key();

    if(!S.job && jobSel.value){
      var id=jobSel.value;for(var i=0;i<JOBS.length;i++){if(JOBS[i].id===id){S.job=JOBS[i];break;}}
    }
    save();
    $('#day').textContent=S.meta.day;
    started=false;
    paintJobDesc();
    nav('#page-rules');
  };
  $('#seeRules').onclick=function(){nav('#page-rules');};
  $('#toRecord').onclick=function(){nav('#page-record');if(!started){started=true;dayStart(true);}};

  // å­¸ç”Ÿè¨˜å¸³
  var tbody=$('#tTable tbody');
  function renderStuTable(){
    var d=S.meta.day,arr=S.tx_stu[d]||[];
    tbody.innerHTML='';
    for(var i=0;i<arr.length;i++){
      var t=arr[i];
      var tr=document.createElement('tr');
      tr.innerHTML='<td>ç¬¬'+(t.day||d)+'å¤©</td>'
        +'<td>'+(t.type==='income'?'æ”¶å…¥':'æ”¯å‡º')+'</td>'
        +'<td>'+transCat(t.cat)+'</td>'
        +'<td class="right">'+t.amt+'</td>'
        +'<td class="right">'+fmtSign(t.e)+'</td>'
        +'<td class="right">'+fmtSign(t.m)+'</td>'
        +'<td>'+(t.note||'')+'</td>'
        +'<td><button class="bad del-row" data-idx="'+i+'">åˆªé™¤</button></td>';
      tbody.appendChild(tr);
    }
  }
  tbody.addEventListener('click',function(e){
    var target=e.target;
    if(target.classList.contains('del-row')){
      var idx=parseInt(target.getAttribute('data-idx'),10);
      var d=S.meta.day;
      if(S.tx_stu[d]){S.tx_stu[d].splice(idx,1);save();renderStuTable();updateStuBarsAndDash();}
    }
  });
  function addStu(t){
    var d=S.meta.day;t.day=d;
    if(!S.tx_stu[d])S.tx_stu[d]=[];
    S.tx_stu[d].push(t);
    save();renderStuTable();updateStuBarsAndDash();
  }
  $('#add').onclick=function(){
    var rawAmt=$('#tAmt').value;
    if(rawAmt===''){alertWarn('è«‹è¼¸å…¥é‡‘é¡ï¼ˆå¯ä»¥æ˜¯ 0 ï¼‰');return;}
    var t={
      type:$('#tType').value,
      cat:$('#tCat').value,
      amt:+rawAmt,
      e:+($('#tE').value||0),
      m:+($('#tM').value||0),
      note:($('#tNote').value||'').trim(),
      ts:Date.now()
    };
    addStu(t);
    $('#tAmt').value='';$('#tE').value='';$('#tM').value='';$('#tNote').value='';
  };
  $('#clear').onclick=function(){
    if(confirm('æ¸…ç©ºä»Šæ—¥æ‰€æœ‰ç´€éŒ„ï¼Ÿ')){
      S.tx_stu[S.meta.day]=[];
      save();renderStuTable();updateStuBarsAndDash();
    }
  };

  // å¾Œå°ç³»çµ±å¸³
  function addSys(t){
    var d=S.meta.day;
    if(!S.tx_sys[d])S.tx_sys[d]=[];
    S.tx_sys[d].push(t);save();
  }

  function calcStuUpTo(day){
    var money = 1000, energy = 100, mood = 100, deaths = 0;
    for (var d = 1; d <= day; d++) {
      var arr = S.tx_stu[d] || [];
      for (var i = 0; i < arr.length; i++) {
        var t = arr[i];
        money  += (t.type === 'income' ? +t.amt : -t.amt);
        energy += t.e || 0;
        mood   += t.m || 0;
      }
      var sysDie = S.deathDays && S.deathDays.indexOf(d) !== -1;
      var stuDie = (money < 0 || energy <= 0 || mood <= 0);
      if (sysDie || stuDie) {
        deaths++;
        if (d < day) {
          money  = 1000;
          energy = 100;
          mood   = 100;
        }
      }
    }
    return {money:money,energy:energy,mood:mood,deaths:deaths};
  }
  function updateStuBarsAndDash(){
    var r=calcStuUpTo(S.meta.day);
    setBars(r.energy,r.mood);
    $('#dashMoney').textContent=Math.round(r.money);
    $('#dashE').textContent=Math.round(r.energy);
    $('#dashM').textContent=Math.round(r.mood);
  }

  function calcSysEndState(day){
    var money=1000,energy=100,mood=100;
    var deaths = S.deathDays||[];
    for(var d=1;d<=day;d++){
      var arr=S.tx_sys[d]||[];
      for(var i=0;i<arr.length;i++){
        var t=arr[i];
        money+=(t.type==='income'?+t.amt:-t.amt);
        energy+=t.e||0;
        mood+=t.m||0;
      }
      if(deaths.indexOf(d)!==-1 && d<day){
        money=1000;energy=100;mood=100;
      }
    }
    return {money:money,energy:energy,mood:mood};
  }

  function getStartStateForDay(d){
    if(d===1)return{money:1000,energy:100,mood:100};
    var prevDay=d-1;
    var endPrev=calcSysEndState(prevDay);
    if(S.deathDays && S.deathDays.indexOf(prevDay)!==-1){
      return {money:1000,energy:100,mood:100};
    }
    return endPrev;
  }

  function calcSysAllForPayload(){
    var r=calcSysEndState(4);
    return{
      money:r.money,
      energy:r.energy,
      mood:r.mood,
      deaths:S.deathCount||0
    };
  }

  var LIMITS={food:3,fun:2,draw:2};
  function canUse(kind){
    var d=S.meta.day,c=S.counters[d]||{food:0,fun:0,draw:0};
    if(kind==='fun'&&S.leave[d])return true;
    if(c[kind]===undefined)return true;
    if(c[kind]>=LIMITS[kind]){
      alertWarn('ä»Šå¤©çš„ã€Œ'+(kind==='food'?'é¤é£Ÿ':kind==='fun'?'ä¼‘é–’':'æŠ½å¡')+'ã€å·²é”ä¸Šé™ã€‚');
      return false;
    }
    return true;
  }
  function used(kind){
    var d=S.meta.day;
    if(!S.counters[d])S.counters[d]={food:0,fun:0,draw:0};
    S.counters[d][kind]++;save();
  }

  // å·¥ä½œæŒ‰éˆ•ç‹€æ…‹ï¼šè€ƒæ…®è«‹å‡ï¼‹ä»Šæ—¥æ˜¯å¦å·²å®Œæˆå·¥ä½œ
  function updateWorkButton(){
    var d=S.meta.day,leave=S.leave[d],used=workUsed[d];
    var btn=$('#work');
    if(leave){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ä»Šå¤©å·²è«‹å‡';
    }else if(used){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ä»Šæ—¥å·²å®Œæˆå·¥ä½œ ğŸ’¼';
    }else{
      btn.disabled=false;
      btn.style.opacity='1';
      btn.textContent='å®Œæˆå·¥ä½œï¼ˆæ•™å¸«èªè­‰ï¼‰';
    }
  }

  $('#leavePaid').onclick=function(){
    var d=S.meta.day;
    if(S.leave[d]){alertWarn('ä»Šå¤©å·²ç¶“æœ‰è«‹å‡ç´€éŒ„ï¼Œç„¡æ³•é‡è¤‡è¨­å®šã€‚');return;}
    if(!S.job){alertWarn('è«‹å…ˆé¸æ“‡è·æ¥­æ‰èƒ½è¨ˆç®—æœ‰è–ªå‡å¤©æ•¸ã€‚');return;}
    if(S.job.pl===0){alertWarn('æ­¤è·æ¥­ç„¡æœ‰è–ªå‡å¤©æ•¸ã€‚');return;}
    if(S.leavePaidUsed>=S.job.pl){alertWarn('å·²ç”¨å®Œæ‰€æœ‰æœ‰è–ªå‡å¤©æ•¸ã€‚');return;}
    S.leave[d]='paid';S.leavePaidUsed++;save();updateWorkButton();
    alertInfo('ä»Šå¤©è¨­å®šç‚ºã€Œæœ‰è–ªå‡ã€ï¼Œ<br>è«‹åœ¨è¨˜å¸³é¢æ¿è‡ªè¡Œå¡«å¯«ï¼š<br>'
      +'æ”¶ï¼æ”¯ï¼šæ”¶å…¥ï¼›é¡åˆ¥ï¼šè–ªè³‡ï¼æ‰“å·¥ï¼›<br>'
      +'é‡‘é¡ï¼šç´„ $'+(S.job?S.job.salary:0)+'ï¼›é«”åŠ› +10ï¼›å¿ƒæƒ… +10ã€‚<br>'
      +'ï¼ˆç•¶å¤©ä¼‘é–’æ´»å‹•æ¬¡æ•¸ä¸é™ï¼‰');
  };
  $('#leaveUnpaid').onclick=function(){
    var d=S.meta.day;
    if(S.leave[d]){alertWarn('ä»Šå¤©å·²ç¶“æœ‰è«‹å‡ç´€éŒ„ï¼Œç„¡æ³•é‡è¤‡è¨­å®šã€‚');return;}
    S.leave[d]='unpaid';save();updateWorkButton();
    alertInfo('ä»Šå¤©è¨­å®šç‚ºã€Œç„¡è–ªå‡ã€ï¼Œä¼‘é–’æ´»å‹•æ¬¡æ•¸ä¸é™ã€‚<br>'
      +'è«‹åœ¨è¨˜å¸³é¢æ¿è‡ªè¡Œå¡«å¯«ï¼š<br>'
      +'æ”¶ï¼æ”¯ï¼šæ”¶å…¥ï¼›é¡åˆ¥ï¼šè–ªè³‡ï¼æ‰“å·¥ï¼›<br>'
      +'é‡‘é¡ï¼š0ï¼›é«”åŠ› +10ï¼›å¿ƒæƒ… +20ã€‚');
  };

  // ç²‰çµ²è´ˆç¦®æŒ‰éˆ•ç‹€æ…‹ï¼šè¦é»‘ç´…å¤§ç¶²ç´…ï¼‹å·²å®Œæˆå·¥ä½œï¼‹éç„¡è–ªå‡ï¼‹ç•¶æ—¥æœªé ˜é
  function updateGiftButtonForDay(){
    var d=S.meta.day;
    var btn=$('#giftBtn');
    if(!S.job || S.job.id!=='mega'){
      btn.classList.add('hidden');
      return;
    }
    btn.classList.remove('hidden');

    if(S.leave[d]==='unpaid'){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ç„¡è–ªå‡ç•¶å¤©ç„¡æ³•é ˜ç¦®ç‰©';
      return;
    }

    if(!workUsed[d]){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='éœ€å…ˆå®Œæˆä»Šæ—¥å·¥ä½œ';
      return;
    }

    if(giftUsed[d]){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ä»Šæ—¥å·²é ˜å– ğŸ';
    }else{
      btn.disabled=false;
      btn.style.opacity='1';
      btn.textContent='ç²‰çµ²è´ˆç¦®ï¼ˆå¤§ç¶²ç´…ï¼‰';
    }
  }

  $('#giftBtn').onclick=function(){
    if(!S.job || S.job.id!=='mega'){
      alertWarn('åªæœ‰ã€Œé»‘ç´…å¤§ç¶²ç´…ã€å¯ä»¥ä½¿ç”¨ç²‰çµ²è´ˆç¦®å–”ï¼');
      return;
    }
    var d=S.meta.day;
    if(S.leave && S.leave[d]==='unpaid'){
      alertWarn('ä»Šå¤©ä½ è«‹äº†ã€Œç„¡è–ªå‡ã€ï¼Œç²‰çµ²å€‘ä¹Ÿæš«æ™‚æ²’æœ‰æ–—å…§å–”ï½<br>æ˜å¤©åŠªåŠ›å·¥ä½œï¼Œå†çœ‹çœ‹ç²‰çµ²æœ‰æ²’æœ‰é€ç¦®ç‰©å§ï¼');
      return;
    }
    if(!workUsed[d]){
      alertWarn('ä»Šå¤©é‚„æ²’å®Œæˆå·¥ä½œï¼Œç²‰çµ²é‚„åœ¨è§€æœ›å‘¢ï½\nè«‹å…ˆå®Œæˆã€Œä»Šæ—¥å·¥ä½œã€ï¼Œå†ä¾†çœ‹æœ‰æ²’æœ‰ç²‰çµ²é€ç¦®ç‰©å§ï¼');
      return;
    }
    if(giftUsed[d]){
      alertInfo('ğŸ€ ä»Šå¤©ç²‰çµ²å·²ç¶“é€éç¦®ç‰©å›‰ï¼Œæ˜å¤©å†çœ‹çœ‹æœ‰æ²’æœ‰æ–°æ–—å…§ï¼');
      return;
    }
    giftUsed[d]=true;
    var gifts=Math.floor(Math.random()*11);
    var total=gifts*20;
    if(gifts===0){
      updateGiftButtonForDay();
      alertInfo('ä»Šå¤©æš«æ™‚æ²’æœ‰ç²‰çµ²æ–—å…§ï¼Œæ˜å¤©å†æ¥å†å²ï¼');
      return;
    }
    addSys({type:'income',cat:'event',amt:total,e:0,m:0,note:'ç²‰çµ²è´ˆç¦® '+gifts+' å€‹'});
    beep('ding');
    alertSuccess('æ­å–œä½ ï½ç²å¾—ç²‰çµ²æ–—å…§ <b>'+gifts+'</b> å€‹ç¦®ç‰©ï¼Œç¸½å…±ç²å¾— <b>'+total+'</b> å…ƒï¼');
    updateGiftButtonForDay();
  };

  // é¤é£Ÿ
  $('#food0').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:0,e:-20,m:-15,note:'ä¸åƒé£¯'});used('food');beep('cash');alertInfo('ğŸ½ ä¸åƒé£¯ â†’ é«”-20 / å¿ƒ-15');};
  $('#food1').onclick=function(){if(!canUse('food'))return;if(!canUse('fun'))return;addSys({type:'expense',cat:'food',amt:100,e:+20,m:+10,note:'è‡ªå·±å‚™é¤'});used('food');used('fun');beep('cash');alertInfo('ğŸ± è‡ªå·±å‚™é¤ -100ï¼Œé«”+20 / å¿ƒ+10ï¼ˆåŒæ™‚å ç”¨ 1 æ¬¡ä¼‘é–’é¡åº¦ï¼‰');};
  $('#food2').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:100,e:+15,m:+10,note:'è·¯é‚Šæ”¤'});used('food');beep('cash');alertInfo('ğŸ¥Ÿ è·¯é‚Šæ”¤ -100ï¼Œé«”+15 / å¿ƒ+10');};
  $('#food3').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:200,e:+30,m:+0,note:'å¥åº·é¤ç›’'});used('food');beep('cash');alertInfo('ğŸ¥— å¥åº·é¤ç›’ -200ï¼Œé«”+30 / å¿ƒ+0');};
  $('#food4').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:300,e:+10,m:+20,note:'å¥¢ä¾ˆé€Ÿé£Ÿ'});used('food');beep('cash');alertInfo('ğŸ” å¥¢ä¾ˆé€Ÿé£Ÿ -300ï¼Œé«”+10 / å¿ƒ+20');};

  // ä¼‘é–’
  $('#fun0').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:200,e:-10,m:+20,note:'çœ‹é›»å½±'});used('fun');beep('ok');alertInfo('ğŸ¬ çœ‹é›»å½± -200ï¼Œé«”-10 / å¿ƒ+20');};
  $('#fun1').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:50,e:-10,m:+15,note:'æ‰“é›»å‹•'});used('fun');beep('ok');alertInfo('ğŸ•¹ æ‰“é›»å‹• -50ï¼Œé«”-10 / å¿ƒ+15');};
  $('#fun2').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:250,e:-10,m:+25,note:'èšé¤'});used('fun');beep('ok');alertInfo('ğŸ» èšé¤ -250ï¼Œé«”-10 / å¿ƒ+25');};
  $('#fun3').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:10,e:-25,m:+15,note:'é‹å‹•'});used('fun');beep('ok');alertInfo('ğŸƒ é‹å‹• -10ï¼Œé«”-25 / å¿ƒ+15');};
  $('#fun4').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:100,e:-5,m:+10,note:'ç•«ç•«ï¼è®€æ›¸'});used('fun');beep('ok');alertInfo('ğŸ¨ ç•«ç•«ï¼è®€æ›¸ -100ï¼Œé«”-5 / å¿ƒ+10');};

  function applyFx(base,fx){return Math.round(base*fx);}

  // ğŸ’¼ å·¥ä½œï¼šæ¯å¤©åªèƒ½ä¸€æ¬¡
  $('#work').onclick=function(){
    if(!S.job){alertWarn('å°šæœªé¸æ“‡è·æ¥­ï¼Œè«‹å›åˆ°å°é¢é¸æ“‡è·æ¥­ã€‚');return;}
    var d=S.meta.day;
    if(S.leave[d]){alertWarn('ä»Šå¤©å·²è«‹å‡ï¼Œç„¡æ³•ä¸Šç­ã€‚');return;}
    if(workUsed[d]){
      alertInfo('ğŸ•“ ä»Šå¤©ä½ å·²ç¶“å®Œæˆå·¥ä½œå›‰ï¼Œæ˜å¤©å†ç¹¼çºŒåŠªåŠ›ï¼');
      return;
    }

    var eff=S.effects[d]||{},fx=eff.fxHint||1;
    Swal.fire({
      title:'æ•™å¸«èªè­‰',
      html:'å·¥ä½œï¼š'+S.job.name+'<br>'
          +'æ¯æ¬¡å®ŒæˆåŸå§‹è–ªè³‡ç´„ $'+S.job.salary+'<br>'
          +'é«”åŠ› '+S.job.e+'ï½œå¿ƒæƒ… '+S.job.m+'<br>'
          +'ä»Šæ—¥è–ªæ°´å€ç‡ï¼š<b>x '+fx.toFixed(2)+'</b>ï¼ˆç³»çµ±å·²è‡ªå‹•å¥—ç”¨ï¼‰',
      input:'password',
      inputPlaceholder:'è«‹ç”±è€å¸«è¼¸å…¥å¯†ç¢¼',
      showCancelButton:true,
      confirmButtonText:'ç¢ºèª',
      cancelButtonText:'å–æ¶ˆ'
    }).then(function(pw){
      if(!pw.isConfirmed)return;
      if((pw.value||'').trim()!==TEACHER){alertError('æ•™å¸«å¯†ç¢¼éŒ¯èª¤');return;}

      if(S.job.id==='eng'){
        Swal.fire({
          title:'å·¥ç¨‹å¸«è–ªè³‡é¸æ“‡',
          html:'è«‹é¸æ“‡ä»Šæ—¥çµ¦è–ªæ–¹å¼ï¼š',
          showDenyButton:true,
          confirmButtonText:'åº•è–ª150ï¼‹çé‡‘350ï¼ˆå…±500ï¼‰',
          denyButtonText:'åƒ…çµ¦åº•è–ª 150'
        }).then(function(ch){
          var base, payNote;
          if(ch.isDenied){base=S.job.base||150;payNote='ï¼ˆåƒ…åº•è–ªï¼‰';}
          else{base=(S.job.base||150)+(S.job.bonus||350);payNote='ï¼ˆåº•è–ªï¼‹å®Œæˆçé‡‘ï¼‰';}
          var finalPay=applyFx(base,fx);
          addSys({type:'income',cat:'salary',amt:finalPay,e:S.job.e,m:S.job.m,
            note:'å®Œæˆå·¥ä½œ-'+S.job.name+payNote+'ï½œåŸå§‹ '+base+' Ã—'+fx.toFixed(2)+' â†’ å¯¦éš› '+finalPay});
          workUsed[d]=true;save();
          updateWorkButton();
          updateGiftButtonForDay();
          beep('ding');
          alertSuccess(
            'ğŸ’¼ å®Œæˆå·¥ä½œï¼<br>'
            +'åŸå§‹è–ªè³‡ï¼š$'+base+' '+payNote+'<br>'
            +'ä»Šæ—¥å€ç‡ï¼šx '+fx.toFixed(2)+'<br>'
            +'ğŸ‘‰ ç³»çµ±å¯¦éš›å…¥å¸³ï¼š<b>$'+finalPay+'</b><br>'
            +'é«”åŠ›'+S.job.e+'ï¼Œå¿ƒæƒ…'+S.job.m+' å·²è¨˜éŒ„åœ¨å¾Œå°ã€‚'
          );
        });
      }else{
        var base=S.job.salary;
        var finalPay=applyFx(base,fx);
        addSys({type:'income',cat:'salary',amt:finalPay,e:S.job.e,m:S.job.m,
          note:'å®Œæˆå·¥ä½œ-'+S.job.name+'ï½œåŸå§‹ '+base+' Ã—'+fx.toFixed(2)+' â†’ å¯¦éš› '+finalPay});
        workUsed[d]=true;save();
        updateWorkButton();
        updateGiftButtonForDay();
        beep('ding');
        alertSuccess(
          'ğŸ’¼ å®Œæˆå·¥ä½œï¼<br>'
          +'åŸå§‹è–ªè³‡ï¼š$'+base+'<br>'
          +'ä»Šæ—¥å€ç‡ï¼šx '+fx.toFixed(2)+'<br>'
          +'ğŸ‘‰ ç³»çµ±å¯¦éš›å…¥å¸³ï¼š<b>$'+finalPay+'</b><br>'
          +'é«”åŠ›'+S.job.e+'ï¼Œå¿ƒæƒ…'+S.job.m+' å·²è¨˜éŒ„åœ¨å¾Œå°ã€‚'
        );
      }
    });
  };

  // æŠ½å¡ï¼ˆDay1 / Day3ï¼Œæ¯æ—¥æœ€å¤š 2 æ¬¡ï¼‰
  $('#btnDraw').onclick=function(){
    var d=S.meta.day;
    if(d!==1 && d!==3){
      alertWarn('åªæœ‰ç¬¬ 1 å¤©èˆ‡ç¬¬ 3 å¤©å¯ä»¥æŠ½äº‹ä»¶å¡å–”ï¼');
      return;
    }
    if(!canUse('draw'))return;

    var isLucky=Math.random()<0.5;
    var deck=isLucky?LUCKY:UNLUCKY;
    var kind=isLucky?'å¹¸é‹':'ä¸å¹¸';
    var p=deck[Math.floor(Math.random()*deck.length)];
    addSys({
      type:(p.amt>=0?'income':'expense'),
      cat:'event',
      amt:Math.abs(p.amt),
      e:p.e||0,
      m:p.m||0,
      note:kind+'ï¼š'+p.name
    });
    used('draw');beep('card');
    alertInfo(kind+'ï¼š'+p.name+'ï¼ˆ'+(p.amt>=0?'+':'')+p.amt+'ï¼Œé«”'+fmtSign(p.e||0)+' / å¿ƒ'+fmtSign(p.m||0)+'ï¼‰');
  };

  function deathMsg(f){
    if(f.e&&f.m&&f.$) return "â˜ ï¸ ä½ å¤ªç´¯ã€å¤ªç…©åˆæ²’éŒ¢ï¼Œæ•´å€‹äººç”Ÿæš«æ™‚å´©ç›¤â€¦â€¦é‡ç½®ç‹€æ…‹ï¼Œæ­»äº¡æ¬¡æ•¸ +1ã€‚";
    if(f.e&&f.m)      return "âš ï¸ ä½ å› ç‚ºèº«é«”éåº¦ç–²å‹åˆæƒ…ç·’å´©æ½°ï¼Œè¢«ç·Šæ€¥é€é†«ä¼‘é¤Šï¼Œé‡ç½®ç‹€æ…‹ä¸¦ +1 æ­»äº¡æ¬¡æ•¸ã€‚";
    if(f.e&&f.$)      return "âš ï¸ ä½ å› ç‚ºé«”åŠ›é€æ”¯åˆè³‡é‡‘çŸ­ç¼ºï¼Œè¢«è¿«æš«åœå·¥ä½œï¼Œé‡ç½®ç‹€æ…‹ä¸¦ +1 æ­»äº¡æ¬¡æ•¸ã€‚";
    if(f.m&&f.$)      return "ğŸ’” ä½ å› ç‚ºæƒ…ç·’å´©æ½°åˆé™·å…¥è²¡å‹™å›°å¢ƒï¼Œè¢«è¿«é‡æ–°é–‹å§‹ï¼Œæ­»äº¡æ¬¡æ•¸ +1ã€‚";
    if(f.e)           return "âš ï¸ ä½ å› ç‚ºèº«é«”éåº¦ç–²å‹è€Œæ˜å€’ï¼Œè¢«ç·Šæ€¥é€é†«æ²»ç™‚ã€‚é‡ç½®ç‹€æ…‹ï¼Œæ­»äº¡æ¬¡æ•¸ +1ã€‚";
    if(f.m)           return "ğŸ’” ä½ å› ç‚ºæƒ…ç·’å´©æ½°ï¼Œæ±ºå®šå…ˆå¥½å¥½ä¼‘æ¯ã€‚é‡ç½®ç‹€æ…‹ï¼Œæ­»äº¡æ¬¡æ•¸ +1ã€‚";
    return "ğŸ’¸ ä½ çš„é‡‘éŒ¢å‡ºç¾èµ¤å­—ï¼Œç„¡æ³•æ”¯ä»˜æ—¥å¸¸é–‹éŠ·ï¼Œè¢«è¿«é‡æ–°è¦åŠƒã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
  }

  function dayStart(first){
    var d=S.meta.day;
    $('#day').textContent=d;
    beep('start');
    if(!S.counters[d])S.counters[d]={food:0,fun:0,draw:0};
    paintJobDesc();

    var html='<h3>ğŸŒ… æ–°çš„ä¸€å¤©é–‹å§‹ï½œDay '+d+'</h3>'
      +'<p>ä»Šå¤©è«‹å®Œæˆä»¥ä¸‹äº‹æƒ…ï¼š</p>'
      +'<ul style="text-align:left;display:inline-block;">'
      +'<li>â‘  åšä½ çš„å·¥ä½œï¼ˆæˆ–è«‹å‡ï¼‰â†’ è³ºéŒ¢ä¸»è¦ä¾†æºã€‚</li>'
      +'<li>â‘¡ é¸æ“‡åƒé£¯ 1ï½3 æ¬¡ â†’ è£œé«”åŠ›ã€‚</li>'
      +'<li>â‘¢ åš 1ï½2 å€‹ä¼‘é–’æ´»å‹• â†’ åŠ å¿ƒæƒ…ã€‚</li>'
      +'<li>â‘£ è‹¥æ˜¯ Day1 æˆ– Day3 â†’ å¯æŠ½å‘½é‹äº‹ä»¶å¡ï¼</li>'
      +'<li>â‘¤ æ³¨æ„ï¼Day2ã€Day4 æœƒæœ‰å¼·åˆ¶èŠ±è²»ï¼Œè¨˜å¾—é ç•™ç¾é‡‘ã€‚</li>'
      +'</ul>';

    var prev=getStartStateForDay(d);
    var fxHint=1,statusNote='';
    if(prev.energy>110){fxHint*=1.5;statusNote+='ğŸ’ª é«”åŠ› &gt;110ï¼šè–ªæ°´ 1.5 å€ã€‚<br>';}
    if(prev.energy<50){fxHint*=0.5;statusNote+='ğŸ˜µ é«”åŠ› &lt;50ï¼ˆéå‹ï¼‰ï¼šè–ªæ°´æ¸›åŠã€‚<br>';}
    if(prev.mood>110){fxHint*=1.5;statusNote+='ğŸ˜„ å¿ƒæƒ… &gt;110ï¼ˆéå¸¸å¿«æ¨‚ï¼‰ï¼šè–ªæ°´ 1.5 å€ã€‚<br>';}
    if(prev.mood<30){fxHint*=0.5;statusNote+='ğŸ˜ å¿ƒæƒ… &lt;30ï¼ˆå¿ƒæƒ…ä½è½ï¼‰ï¼šè–ªæ°´æ¸›åŠã€‚<br>';}

    S.effects[d]={fxHint:fxHint};save();
    if(statusNote)html+='<hr><p>'+statusNote+'</p>';

    if(S.deathDays && S.deathDays.indexOf(d-1)!==-1){
      html+='<p>â˜ ï¸ æ˜¨å¤©ä½ æœ‰å› ç‚ºé‡‘éŒ¢æˆ–é«”åŠ›ï¼å¿ƒæƒ…æ­¸ 0 è€Œã€Œæ­»äº¡é‡ç”Ÿã€ï¼Œ<br>'
           +'ç³»çµ±å·²å°‡ä½ é‡ç½®ç‚ºé‡‘éŒ¢ 1000ã€é«”åŠ› 100ã€å¿ƒæƒ… 100 å†é‡æ–°é–‹å§‹ä»Šå¤©ã€‚</p>';
    }

    if(d===1||d===3)html+='<p>ğŸ² ä»Šå¤©å¯ä»¥æŠ½å‘½é‹äº‹ä»¶å¡ï¼Œå»ºè­°æŠ½ 1ï½2 æ¬¡ã€‚</p>';
    if(d===2){
      addSys({type:'expense',cat:'event',amt:250,e:0,m:0,note:'å¼·åˆ¶ï¼šç¹³ç­è²»'});
      html+='<p>ğŸ“Œ ä»Šå¤©æœƒè‡ªå‹•ç™¼ç”Ÿã€Œç¹³ç­è²»ã€ï¼Œè«‹ç•™æ„é‡‘éŒ¢è®ŠåŒ–ï¼ˆå¾Œå°å·²æ‰£ 250ï¼‰ã€‚</p>';
    }
    if(d===4){
      addSys({type:'expense',cat:'event',amt:150,e:0,m:0,note:'å¼·åˆ¶ï¼šæ°´é›»è²»ï¼å†·æ°£å„²å€¼'});
      html+='<p>ğŸ“Œ ä»Šå¤©æœƒè‡ªå‹•ç™¼ç”Ÿã€Œæ°´é›»è²»ï¼å†·æ°£å„²å€¼ã€ï¼Œè«‹ç•™æ„é‡‘éŒ¢è®ŠåŒ–ï¼ˆå¾Œå°å·²æ‰£ 150ï¼‰ã€‚</p>';
    }

    var allowDraw=(d===1||d===3);
    $('#drawBlock').classList.toggle('hidden',!allowDraw);

    $('#alerts').innerHTML=html;
    alertInfo(html+'<br><b>è«‹ç¢ºèªè‡ªå·±ä»Šå¤©è¦åšå“ªäº›äº‹ï¼Œå†é–‹å§‹è¡Œå‹•ï¼</b>');
    updateStuBarsAndDash();
    updateWorkButton();
    updateGiftButtonForDay();
  }

  $('#endDay').onclick=function(){
    var d=S.meta.day;
    var st=calcSysEndState(d);
    var f={$:st.money<0,e:st.energy<=0,m:st.mood<=0};
    if(f.$||f.e||f.m){
      if(!S.deathDays)S.deathDays=[];
      if(S.deathDays.indexOf(d)===-1)S.deathDays.push(d);
      S.deathCount=(S.deathCount||0)+1;
      save();
      beep('dead');alertWarn(deathMsg(f));
    }else{
      beep('warn');alertInfo('ğŸŒ™ ä»Šå¤©çµæŸäº†ï¼Œè¾›è‹¦äº†ï¼');
    }

    if(S.meta.day<4){
      S.meta.day++;save();dayStart(false);
    }else{
      nav('#page-summary');updateSummary(true);
    }
  };

  function finalPayload(){
    var id=key().replace(PFX+':','');
    var sys=calcSysAllForPayload(),stu=calcStuUpTo(4);
    return{
      key:id,day:S.meta.day,
      system:{money:Math.round(sys.money),energy:Math.round(sys.energy),mood:Math.round(sys.mood),deaths:sys.deaths},
      student:{money:Math.round(stu.money),energy:Math.round(stu.energy),mood:Math.round(stu.mood),deaths:stu.deaths}
    };
  }

  function fillDetailTable(sel, src){
    var tb = $(sel);
    tb.innerHTML = '';
    var deathDays = S.deathDays || [];
    var markUsed = {};
    for (var d = 1; d <= 4; d++) {
      var arr = src[d] || [];
      for (var i = 0; i < arr.length; i++) {
        var t = arr[i];
        var noteText = t.note || '';
        if (deathDays.indexOf(d) !== -1 && !markUsed[d]) {
          noteText += (noteText ? 'ï½œ' : '') + 'ã€æ­¤æ—¥çµæŸå¾Œæ­»äº¡é‡ç”Ÿã€‘';
          markUsed[d] = true;
        }
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + d + '</td>' +
          '<td>' + (t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º') + '</td>' +
          '<td>' + transCat(t.cat) + '</td>' +
          '<td class="right">' + t.amt + '</td>' +
          '<td class="right">' + fmtSign(t.e) + '</td>' +
          '<td class="right">' + fmtSign(t.m) + '</td>' +
          '<td>' + noteText + '</td>';
        tb.appendChild(tr);
      }
    }
  }

  function updateSummary(success){
    var sys=calcSysAllForPayload(),stu=calcStuUpTo(4);
    $('#smMoney').textContent=Math.round(sys.money);
    $('#smE').textContent=Math.round(sys.energy);
    $('#smM').textContent=Math.round(sys.mood);
    $('#smD').textContent=sys.deaths;
    $('#stMoney').textContent=Math.round(stu.money);
    $('#stE').textContent=Math.round(stu.energy);
    $('#stM').textContent=Math.round(stu.mood);
    $('#stD').textContent=stu.deaths;

    var diff=Math.abs(stu.money-sys.money);
    var msg='ä½ èˆ‡ç³»çµ±é‡‘éŒ¢å·®è·ï¼š$'+diff+'ã€‚';
    if(diff<=50)msg+='ğŸŸ¢ è¨˜å¸³éå¸¸ç²¾æº–ï¼';
    else if(diff<=200)msg+='ğŸŸ¡ å¯èƒ½æ¼è¨˜äº†ä¸€äº›èŠ±è²»ï½';
    else msg+='ğŸ”´ æª¢æŸ¥æ˜¯å¦éºæ¼äº‹ä»¶æˆ–å›ºå®šæ”¯å‡ºã€‚';

    var dd=(S.deathDays||[]).slice().sort(function(a,b){return a-b;});
    var deadInfo=dd.length
      ? 'ç³»çµ±åµæ¸¬æ­»äº¡ç™¼ç”Ÿæ—¥ï¼šDay '+dd.join('ã€')+'ã€‚'
      : 'æœ¬æ¬¡æ²’æœ‰ç³»çµ±åµæ¸¬åˆ°æ­»äº¡äº‹ä»¶ã€‚';

    $('#delta').textContent=msg+' '+deadInfo;

    fillDetailTable('#sysTable tbody',S.tx_sys);
    fillDetailTable('#stuTable tbody',S.tx_stu);

    if(success){
      alertSuccess('ğŸ‰ æ­å–œå®Œæˆ 4 å¤©æŒ‘æˆ°ï¼<br>çœ‹çœ‹ç³»çµ±è¨˜éŒ„ vs ä½ è‡ªå·±çš„è¨˜å¸³ï¼Œæœ‰æ²’æœ‰å¾ˆæ¥è¿‘å‘¢ï¼Ÿ');
      beep('ding');setTimeout(function(){beep('ding');},200);
    }
  }

  var sumBtn=document.querySelector('.sticky [data-nav="#page-summary"]');
  sumBtn.onclick=function(){nav('#page-summary');updateSummary(false);};

  function openForm(obj){
    if(!S.formURL){alertWarn('è€å¸«å°šæœªè¨­å®šè¡¨å–®ç¶²å€');return;}
    window.open(S.formURL+encodeURIComponent(JSON.stringify(obj)),'_blank');
  }
  $('#sendEnd').onclick=function(){openForm(finalPayload());};
  $('#copy').onclick=function(){
    var txt=JSON.stringify(finalPayload());
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(function(){alertSuccess('å·²è¤‡è£½ JSONï¼Œå¯è²¼åˆ°è¡¨å–®æˆ–è€å¸«ç«¯ã€‚');})
      .catch(function(){alertInfo(txt);});
    }else alertInfo(txt);
  };

  $('#tun').onclick=function(){
    if(($('#tpw').value||'').trim()===TEACHER){$('#tTools').classList.remove('hidden');}
    else alertError('æ•™å¸«ç¢¼éŒ¯èª¤');
  };
  $('#saveForm').onclick=function(){
    S.formURL=($('#formURL').value||'').trim();save();
    $('#formSaved').textContent=S.formURL?'å·²è¨­å®š':'â€”';
  };
  $('#parse').onclick=function(){
    var tb=$('#aggT tbody');tb.innerHTML='';
    var lines=($('#agg').value||'').split(/\n+/);
    lines=lines.map(function(s){return s.trim();}).filter(function(s){return s;});
    for(var i=0;i<lines.length;i++){
      var line=lines[i];
      try{
        var j=JSON.parse(line),sys=j.system||{},stu=j.student||{};
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+j.key+'</td><td>'+(j.day||'')+'</td>'
          +'<td>'+(sys.money||'')+'</td><td>'+(stu.money||'')+'</td>'
          +'<td>'+(sys.energy||'')+'</td><td>'+(stu.energy||'')+'</td>'
          +'<td>'+(sys.mood||'')+'</td><td>'+(stu.mood||'')+'</td>'
          +'<td>'+(sys.deaths||'')+'</td><td>'+(stu.deaths||'')+'</td>';
        tb.appendChild(tr);
      }catch(e){
        var tr2=document.createElement('tr');
        tr2.innerHTML='<td colspan="10">âŒ ç„¡æ³•è§£æï¼š'+line+'</td>';
        tb.appendChild(tr2);
      }
    }
  };
  $('#csvAll').onclick=function(){
    var lines=($('#agg').value||'').split(/\n+/);
    lines=lines.map(function(s){return s.trim();}).filter(function(s){return s;});
    if(!lines.length){alertWarn('è«‹å…ˆè²¼ä¸Šä¸¦è§£æå­¸ç”Ÿ JSON');return;}
    var rows=[["student","day","sys_money","stu_money","sys_energy","stu_energy","sys_mood","stu_mood","sys_deaths","stu_deaths"]];
    for(var i=0;i<lines.length;i++){
      var line=lines[i];
      try{
        var j=JSON.parse(line),sys=j.system||{},stu=j.student||{};
        rows.push([j.key||'',j.day||'',sys.money||'',stu.money||'',sys.energy||'',stu.energy||'',sys.mood||'',stu.mood||'',sys.deaths||'',stu.deaths||'']);
      }catch(e){rows.push(["BAD:"+line]);}
    }
    var csv=rows.map(function(r){
      return r.map(function(v){var s=String(v).replace(/"/g,'""');return '"'+s+'"';}).join(',');
    }).join('\n');
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download='class-summary-v60.csv';a.click();
  };

  $$('.sticky [data-nav]').forEach(function(b){
    var target=b.getAttribute('data-nav');
    if(target!=='#page-summary'){
      b.onclick=function(){nav(target);};
    }
  });
  function boot(){var h=location.hash||'#page-cover';nav(h);}
  window.addEventListener('hashchange',boot);boot();

})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥½æ¼¾äººç”Ÿï½œé›™ä¸­æ¨¡æ“¬å¸‚æ°‘ v6.reset+hint.5+loan-invest-saving</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{
      --bg:#0b1020;--card:#121933;--line:#22305f;--ink:#e8eeff;--muted:#a8b7e8;
      --ok:#123d2c;--ok2:#1c7c4f;--warn:#3a2b12;--warn2:#996f2a;--bad:#3a1212;--bad2:#912a2a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Arial;
      line-height:1.2;
    }
    header{
      position:sticky;top:0;z-index:4;
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 14px;
      border-bottom:1px solid var(--line);
      background:#0b1020cc;
      backdrop-filter:blur(6px);
    }
    header h1{font-size:16px;margin:0}
    main{padding:12px 12px 110px;max-width:1080px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 12px 24px rgba(0,0,0,.25);overflow:hidden}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}}
    input,select,button,textarea{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid #2a3a78;background:#0f1a3b;color:var(--ink)}
    input,textarea{outline:none}
    button{cursor:pointer}
    .primary{background:#163183;border-color:#2c4fb2}
    .good{background:var(--ok);border-color:var(--ok2)}
    .warn{background:var(--warn);border-color:var(--warn2)}
    .bad{background:var(--bad);border-color:var(--bad2)}
    .badge{border:1px solid #31408a;border-radius:999px;padding:4px 10px;color:#cdd8ff;font-size:12px}
    .pill{padding:4px 10px;border-radius:999px;background:#0e1630;border:1px solid #1d2a63;color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse;table-layout:auto}
    .table th,.table td{border-bottom:1px solid var(--line);padding:6px 4px;text-align:left;font-size:13px;white-space:nowrap}
    .hidden{display:none}
    .right{text-align:right}
    .note{color:var(--muted);font-size:12px;line-height:1.3}
    .bar{height:10px;border-radius:999px;background:#0e1630;border:1px solid #1d2a63;overflow:hidden;min-width:160px}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#3b82f6,#60a5fa);width:100%}
    .sticky{position:fixed;bottom:0;left:0;right:0;background:#0b1020f2;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:space-around;padding:8px;z-index:9}
    .scroll-table{max-height:260px;overflow-y:auto;overflow-x:auto}
    .h4{font-size:16px;margin:0 0 6px}
    .dash{display:flex;gap:10px;flex-wrap:wrap}
    .dash .box{background:#0f1a3b;border:1px solid #2a3a78;border-radius:12px;padding:10px 12px;min-width:120px}
    .dash .box b{font-size:18px}
    .fab{position:fixed;right:16px;bottom:72px;z-index:5;padding:12px 16px;border-radius:999px;background:#1e3a8a;border:1px solid #3b82f6;color:#fff;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .swal2-html-container{text-align:left !important;} /* æç¤ºæ–‡å­—ç½®å·¦ */
    #tAmt,#tE,#tM{width:90px}
    label{white-space:nowrap;} /* è®“ã€Œå§“åã€ä¸æœƒè¢«æ‹†é–‹ */
    /* æ¯æ—¥æ¯”è¼ƒè¡¨ï¼šæˆå°æ¬„ä½åŒè‰² */
    .pair-money{background:#101832;}
    .pair-energy{background:#111a3a;}
    .pair-mood{background:#131f45;}
    .pair-money th,.pair-energy th,.pair-mood th{border-bottom-color:#2b3b74;}
  </style>
</head>
<body>

<header>
  <h1>å¥½æ¼¾äººç”Ÿï½œé›™ä¸­æ¨¡æ“¬å¸‚æ°‘</h1>
  <div class="row">
    <span id="who" class="pill">æœªç™»å…¥</span>
    <button id="btnSound" class="primary">ğŸ”ˆ æç¤ºéŸ³é–‹</button>
  </div>
</header>

<main id="main">

  <!-- ğŸ“‡ å°é¢ -->
  <section id="page-cover" class="card">
    <h3>ğŸ“‡ å°é¢</h3>
    <div class="grid-2">
      <div class="card">
        <div class="row">
          <label>ç­ç´š</label>
          <input id="klass" autocomplete="off" placeholder="901" style="width:90px">
          <label>åº§è™Ÿ</label>
          <input id="no" autocomplete="off" placeholder="12" style="width:70px">
          <label>å§“å</label>
          <input id="name" autocomplete="off" placeholder="ç‹å°æ˜" style="width:120px">
        </div>
        <div class="row">
          <label>è·æ¥­</label>
          <select id="job"></select>
        </div>
        <div id="jobDesc" class="note">
          è«‹é¸æ“‡è·æ¥­ï¼Œå³å´æœƒé¡¯ç¤ºå·¥ä½œå…§å®¹ã€è–ªè³‡ã€é«”åŠ›ï¼å¿ƒæƒ…è€—æèˆ‡æœ‰è–ªå‡å¤©æ•¸ã€‚
        </div>
        <div class="row" style="margin-top:8px">
          <button id="start" class="primary">å„²å­˜ä¸¦é–‹å§‹ï¼ˆDay1ï¼‰</button>
          <button id="seeRules" class="warn">æŸ¥çœ‹è¦å‰‡</button>
        </div>
      </div>
      <div class="card">
        <div class="row"><span class="pill">å­¸ç”Ÿè­˜åˆ¥</span><span id="sid" class="badge">å°šæœªå»ºç«‹</span></div>
        <div class="row"><span class="pill">å·²é¸è·æ¥­</span><span id="jobNow" class="badge">â€”</span></div>
        <div class="row">
          <span class="pill">èµ·å§‹é‡‘éŒ¢</span>
          <div class="bar"><span style="width:100%"></span></div>
          <span class="pill" id="startMoney">1000</span>
        </div>
        <div class="row">
          <span class="pill">é«”åŠ›</span>
          <div class="bar"><span id="eBar"></span></div>
          <span id="eVal" class="pill">100</span>
        </div>
        <div class="row">
          <span class="pill">å¿ƒæƒ…</span>
          <div class="bar"><span id="mBar"></span></div>
          <span id="mVal" class="pill">100</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ¯ è¦å‰‡èªªæ˜é  -->
  <section id="page-rules" class="card hidden">
    <h2>ğŸ¯ éŠæˆ²ä»»å‹™èªªæ˜</h2>
    <p>
      ä½ å°‡é«”é©— 4 å¤©çš„ã€Šå¥½æ¼¾äººç”Ÿæ¨¡æ“¬å¸‚æ°‘ã€‹ã€‚<br>
      ç›®æ¨™æ˜¯ï¼š<strong>è®“é‡‘éŒ¢ ğŸ’µã€é«”åŠ› â¤ï¸ã€å¿ƒæƒ… ğŸ˜Š éƒ½ç¶­æŒåœ¨å®‰å…¨ç¯„åœ</strong>ã€‚<br><br>
      ğŸ’€ ä»»ä¸€æ•¸å€¼è®Šæˆ 0 æœƒã€Œæ­»äº¡é‡ç”Ÿã€ï¼Œè¨˜ 1 æ¬¡æ­»äº¡ã€‚<br>
      ğŸ† çµæŸæ™‚æœƒçœ‹ä¸‰å€‹æ•¸å€¼èˆ‡æ­»äº¡æ¬¡æ•¸ï¼Œèª°æœ€å¹³è¡¡èª°å°±æœ€å²å®³ã€‚
    </p>

    <h3>ğŸ§© åŸºæœ¬ç©æ³•</h3>
    <ul>
      <li>ğŸ’µ é ã€Œå·¥ä½œã€æŠ•è³‡ã€è³ºéŒ¢ã€‚</li>
      <li>â¤ï¸ é ã€Œåƒé£¯ã€å›é«”åŠ›ï¼Œæ¯å¤©å»ºè­° 1ï½3 é¤ã€‚</li>
      <li>ğŸ˜Š é ã€Œä¼‘é–’æ´»å‹•ã€åŠ å¿ƒæƒ…ã€‚</li>
      <li>ğŸ² Day1ã€Day3 å¯æŠ½å‘½é‹äº‹ä»¶å¡ï¼ˆæœ‰å¥½æœ‰å£ï¼‰ã€‚</li>
      <li>ğŸ’¸ Day2ã€Day4 æœƒæœ‰å¼·åˆ¶æ”¯å‡ºï¼Œè¦è¨˜å¾—ç•™ç¾é‡‘ã€‚</li>
    </ul>

    <div class="card">
      <b>é«”åŠ›ï¼å¿ƒæƒ…å°è–ªæ°´çš„å½±éŸ¿ï¼ˆç³»çµ±è‡ªå‹•å¥—ç”¨ï¼‰</b>
      <ul>
        <li>é«”åŠ› &gt; 110ï¼šè–ªæ°´ Ã—1.5</li>
        <li>é«”åŠ› &lt; 50ï¼šè–ªæ°´ Ã·2</li>
        <li>å¿ƒæƒ… &gt; 110ï¼šè–ªæ°´ Ã—1.5</li>
        <li>å¿ƒæƒ… &lt; 30ï¼šè–ªæ°´ Ã·2</li>
      </ul>
      <p class="note">ï¼Šè€å¸«ç™¼ç©å…·éˆ”æ™‚ä¹Ÿå¯åƒè€ƒé€™å€‹å€ç‡ã€‚</p>
    </div>

    <!-- ğŸ§¾ è¦å‰‡é è¨˜å¸³æé†’ -->
    <div class="card">
      <h3 class="h4">ğŸ§¾ è¨˜å¸³è¦å‰‡èªªæ˜</h3>
      <p>
        æ¯å®Œæˆä¸€ä»¶äº‹ï¼ˆå·¥ä½œã€é¤é£Ÿã€ä¼‘é–’ã€å€Ÿæ¬¾ï¼é‚„æ¬¾ã€äº‹ä»¶å¡ã€å¼·åˆ¶æ”¯å‡ºâ‹¯ï¼‰ï¼Œ<br>
        è«‹åœ¨ã€Œè¨˜å¸³ã€é è‡ªå·±å¡«ï¼š<br>
        ğŸ’° é‡‘é¡ ï¼‹ â¤ï¸ é«”åŠ›è®ŠåŒ– ï¼‹ ğŸ˜Š å¿ƒæƒ…è®ŠåŒ–ã€‚<br><br>
        ç³»çµ±æœƒåœ¨å¾Œå°è¨˜ã€ŒçœŸå¯¦æ•¸å€¼ã€ï¼Œ<br>
        ç¬¬ 4 å¤©æ‰ä¸€æ¬¡å…¬é–‹ï¼Œè·Ÿä½ çš„è¨˜å¸³æ¯”å°ã€‚
      </p>
    </div>

    <button id="toRecord" class="primary">å»è¨˜å¸³ â–¶</button>
  </section>

  <!-- ğŸ§¾ è¨˜å¸³é  -->
  <section id="page-record" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h3>ğŸ§¾ è¨˜å¸³ï¼ˆç¬¬ <span id="day">1</span> å¤©ï¼‰</h3>
      <span class="pill">ä¸‹é¢æ˜¯ä½ è‡ªå·±çš„è¨˜å¸³ï¼Œç³»çµ±æœƒå¦å­˜ä¸€ä»½ã€ŒçœŸå¯¦ç´€éŒ„ã€ã€‚</span>
    </div>

    <!-- ç›®å‰è·æ¥­è³‡è¨Š -->
    <div id="jobBanner" class="card" style="margin-top:8px;margin-bottom:12px;">
      <div class="note">ç›®å‰å°šæœªé¸æ“‡è·æ¥­ï¼Œè«‹å…ˆå›åˆ°ã€Œå°é¢ã€é é¸è·æ¥­ã€‚</div>
    </div>

    <!-- ğŸŒ… æ¯æ—¥æç¤º -->
    <div id="alerts" class="card">
      <h3>ğŸŒ… æ–°çš„ä¸€å¤©é–‹å§‹ï¼</h3>
      <p>
        ä»Šæ—¥é‡é»ï¼š<br>
        â‘  ä¸Šç­æˆ–è«‹å‡ï¼ˆä¸»è¦æ”¶å…¥ï¼‰ã€‚<br>
        â‘¡ åƒé£¯ 1ï½3 æ¬¡ï¼ˆé¡§é«”åŠ›ï¼‰ã€‚<br>
        â‘¢ åš 1ï½2 å€‹ä¼‘é–’æ´»å‹•ï¼ˆé¡§å¿ƒæƒ…ï¼‰ã€‚<br>
        â‘£ Day1ã€3 å¯æŠ½äº‹ä»¶å¡ã€‚<br>
        â‘¤ Day2ã€4 æœƒæœ‰å›ºå®šæ”¯å‡ºï¼Œè¦ç•™éŒ¢ã€‚
      </p>
    </div>

    <!-- å¿«æ·éµ -->
    <div class="card">
      <div class="grid-2">
        <!-- å·¦ï¼šå·¥ä½œï¼‹è«‹å‡ï¼‹ä¼‘é–’ -->
        <div>
          <div class="h4">ğŸ’¼ å·¥ä½œèˆ‡è«‹å‡</div>
          <div class="row">
            <button id="work" class="primary">å®Œæˆå·¥ä½œï¼ˆæ•™å¸«èªè­‰ï¼‰</button>
            <button id="loanBtn" class="primary">å€Ÿæ¬¾ï¼é‚„æ¬¾</button>
            <button id="investBtn" class="primary">æŠ•è³‡</button>
            <button id="savingBtn" class="primary">æ´»å­˜</button>
            <button id="giftBtn" class="good hidden">ç²‰çµ²è´ˆç¦®ï¼ˆå¤§ç¶²ç´…ï¼‰</button>
          </div>
          <div class="row">
            <button id="leavePaid" class="good">è«‹æœ‰è–ªå‡</button>
            <button id="leaveUnpaid" class="warn">è«‹ç„¡è–ªå‡</button>
          </div>
          <p class="note">
            æœ‰è–ªå‡ï¼šç…§é ˜è–ªæ°´ï¼Œä¼‘é–’ä¸é™æ¬¡ã€‚<br>
            ç„¡è–ªå‡ï¼šæ²’è–ªæ°´ï¼Œä¼‘é–’ä¸é™æ¬¡ã€‚<br>
            é‡‘éŒ¢ã€é«”åŠ›ã€å¿ƒæƒ…è«‹åˆ°ä¸‹æ–¹ã€Œè¨˜å¸³ã€è‡ªå·±å¡«ã€‚
          </p>

          <hr>

          <div class="h4">ğŸ® ä¼‘é–’æ´»å‹•ï¼ˆæ¯æ—¥æœ€å¤š 2 æ¬¡ï¼Œå¦‚ç•¶å¤©è«‹å‡å‰‡ç„¡ä¸Šé™ï¼‰</div>
          <p class="note">
            ä¸€èˆ¬æƒ…æ³ï¼šæ¯å¤©æœ€å¤š 2 å€‹ä¼‘é–’æ´»å‹•ã€‚<br>
            ç•¶å¤©æœ‰è«‹å‡æ™‚ï¼šä¼‘é–’æ¬¡æ•¸ä¸é™ã€‚
          </p>
          <div class="row">
            <button id="fun0" class="good">çœ‹é›»å½±ï¼ˆéŒ¢-200 / é«”-10 / å¿ƒ+20ï¼‰</button>
            <button id="fun1" class="good">æ‰“é›»å‹•ï¼ˆéŒ¢-50 / é«”-10 / å¿ƒ+15ï¼‰</button>
            <button id="fun2" class="good">èšé¤ï¼ˆéŒ¢-250 / é«”-10 / å¿ƒ+25ï¼‰</button>
            <button id="fun3" class="good">é‹å‹•ï¼ˆéŒ¢-10 / é«”-25 / å¿ƒ+15ï¼‰</button>
            <button id="fun4" class="good">ç•«ç•«ï¼è®€æ›¸ï¼ˆéŒ¢-100 / é«”-5 / å¿ƒ+10ï¼‰</button>
          </div>
        </div>

        <!-- å³ï¼šé¤é£Ÿï¼‹æŠ½å¡ -->
        <div>
          <div class="h4">ğŸ± é¤é£Ÿï¼ˆæ¯æ—¥æœ€å¤š 3 æ¬¡ï¼‰</div>
          <p class="note">
            æ¯å¤©è‡³å°‘åƒä¸€é¤ï¼Œä¸åƒæœƒæ‰é«”åŠ›ä¹Ÿæ‰å¿ƒæƒ…ã€‚<br>
            è‡ªå·±ç…®æœƒå  1 å€‹ä¼‘é–’åé¡ã€‚
          </p>
          <div class="row">
            <button id="food0" class="warn">ä¸åƒé£¯ï¼ˆéŒ¢0 / é«”-20 / å¿ƒ-15ï¼‰</button>
            <button id="food1" class="warn">è‡ªå·±å‚™é¤ï¼ˆéŒ¢-100 / é«”+20 / å¿ƒ+10ï¼‰</button>
            <button id="food2" class="warn">è·¯é‚Šæ”¤ï¼ˆéŒ¢-100 / é«”+15 / å¿ƒ+10ï¼‰</button>
            <button id="food3" class="warn">å¥åº·é¤ç›’ï¼ˆéŒ¢-200 / é«”+30 / å¿ƒ+0ï¼‰</button>
            <button id="food4" class="warn">å¥¢ä¾ˆé€Ÿé£Ÿï¼ˆéŒ¢-300 / é«”+10 / å¿ƒ+20ï¼‰</button>
          </div>

          <div id="drawBlock" style="margin-top:12px">
            <div class="h4">ğŸ² å‘½é‹äº‹ä»¶å¡ï¼ˆDay1ã€Day3ï¼Œæ¯æ—¥æœ€å¤š 2 æ¬¡ï¼‰</div>
            <div class="row">
              <button id="btnDraw" class="primary">æŠ½äº‹ä»¶å¡ï¼ˆå¹¸é‹ï¼ä¸å¹¸ï¼‰</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ğŸ•’ æœ€è¿‘ 2 ç­†ç³»çµ±ç´€éŒ„ -->
      <div class="card" style="margin-top:12px;">
        <div class="h4">ğŸ•’ ç•¶å¤©æœ€è¿‘ 2 ç­†ã€Œç³»çµ±ç´€éŒ„ã€</div>
        <p id="quickLog" class="note">
          ç›®å‰å°šæœªæœ‰ç´€éŒ„ã€‚ç•¶ä½ æŒ‰ä¸Šé¢çš„å¿«æ·éµã€å®Œæˆå·¥ä½œã€ç²‰çµ²è´ˆç¦®æˆ–é‡åˆ°å¼·åˆ¶æ”¯å‡ºæ™‚ï¼Œé€™è£¡æœƒé¡¯ç¤ºç•¶å¤©æœ€è¿‘ 2 ç­†å¾Œå°è¡Œç‚ºã€‚
        </p>
      </div>
    </div>

    <!-- è¨˜å¸³èˆ‡æ˜ç´° -->
    <div class="card">
      <div class="h4">ğŸ§¾ è¨˜å¸³èˆ‡ä»Šæ—¥æ˜ç´°</div>
      <div id="jobRule" class="note" style="margin-bottom:6px;">è·æ¥­ï¼šâ€”</div>
      <p class="note">
        æ¯åšä¸€ä»¶äº‹ï¼Œå°±åœ¨é€™è£¡å¹«è‡ªå·±è¨˜å¸³ï¼šæ”¶ï¼æ”¯ã€é¡åˆ¥ã€é‡‘é¡ã€é«”åŠ›è®ŠåŒ–ã€å¿ƒæƒ…è®ŠåŒ–ã€‚<br>
        ä¸‹æ–¹å„€è¡¨æ¿åªçœ‹ã€Œä½ è‡ªå·±ã€çš„è¨˜éŒ„ï¼Œå’Œç³»çµ±å¯èƒ½æœƒæœ‰å·®ç•°ã€‚
      </p>
      <div class="grid-2">
        <div>
          <div class="row">
            <label>æ”¶ï¼æ”¯</label>
            <select id="tType">
              <option value="income">æ”¶å…¥</option>
              <option value="expense">æ”¯å‡º</option>
            </select>
            <label>é¡åˆ¥</label>
            <select id="tCat">
              <option value="salary">è–ªè³‡ï¼æ‰“å·¥</option>
              <option value="food">é¤é£Ÿ</option>
              <option value="leisure">ä¼‘é–’</option>
              <option value="bank">éŠ€è¡Œï¼åˆ©æ¯</option>
              <option value="loan">å€Ÿæ¬¾ï¼é‚„æ¬¾</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          <div class="row">
            <label>é‡‘é¡</label>
            <input id="tAmt" type="number" placeholder="å¯ç‚º 0">
            <label>é«”åŠ›è®ŠåŒ–</label>
            <input id="tE" type="number" placeholder="-10 æˆ– 20">
            <label>å¿ƒæƒ…è®ŠåŒ–</label>
            <input id="tM" type="number" placeholder="+15 æˆ– -5">
          </div>
          <div class="row">
            <label>å‚™è¨»</label>
            <input id="tNote" style="flex:1" placeholder="ä¾‹å¦‚ï¼šçœ‹é›»å½±ï¼ç¹³ç­è²»">
            <button id="add" class="primary">åŠ å…¥æœ¬æ—¥</button>
          </div>
          <div class="dash">
            <div class="box">ç›®å‰é‡‘éŒ¢<br><b id="dashMoney">1000</b></div>
            <div class="box">ç›®å‰é«”åŠ›<br><b id="dashE">100</b></div>
            <div class="box">ç›®å‰å¿ƒæƒ…<br><b id="dashM">100</b></div>
          </div>
        </div>
        <div>
          <div class="scroll-table">
            <table class="table" id="tTable">
              <thead>
              <tr><th>æ—¥æœŸ</th><th>æ”¶ï¼æ”¯</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>é«”</th><th>å¿ƒ</th><th>å‚™è¨»</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="row"><button id="clear" class="warn">æ¸…ç©ºä»Šæ—¥</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ çµç®—é  -->
  <section id="page-summary" class="card hidden">
    <h3>ğŸ‰ æ­å–œå®Œæˆ 4 å¤©æŒ‘æˆ°ï¼</h3>
    <p>
      ä¾†çœ‹çœ‹ä½ é€™ 4 å¤©éå¾—å¦‚ä½•ï¼š<br>
      é‡‘éŒ¢æœ‰æ²’æœ‰è¦‹åº•ï¼Ÿé«”åŠ›æ’å¾—ä½å—ï¼Ÿå¿ƒæƒ…é‚„é–‹å¿ƒå—ï¼Ÿ<br><br>
      æ­»äº¡æœƒæ‰£åˆ†ï¼Œæ¬ éŒ¢ä¹Ÿæœƒè¢«æ‰£åˆ†ã€‚<br>
      ä¸‰å€‹æ•¸å€¼éƒ½ç©©ã€åˆæ²’æ¬ å‚µï¼Œå°±æ˜¯ã€Œäººç”Ÿå¹³è¡¡ç‹ã€ï¼
    </p>

    <div class="grid-2">
      <div class="card">
        <h4 class="h4">ç³»çµ±å¾Œå°è¨ˆç®—</h4>
        <div class="row">
          <span class="pill">é‡‘ï¼š<span id="smMoney">0</span></span>
          <span class="pill">é«”ï¼š<span id="smE">0</span></span>
          <span class="pill">å¿ƒï¼š<span id="smM">0</span></span>
          <span class="pill">æ­»ï¼š<span id="smD">0</span></span>
        </div>
      </div>
      <div class="card">
        <h4 class="h4">å­¸ç”Ÿè‡ªè¡Œè¨˜å¸³</h4>
        <div class="row">
          <span class="pill">é‡‘ï¼š<span id="stMoney">0</span></span>
          <span class="pill">é«”ï¼š<span id="stE">0</span></span>
          <span class="pill">å¿ƒï¼š<span id="stM">0</span></span>
          <span class="pill">æ­»ï¼š<span id="stD">0</span></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h4 class="h4">ğŸ“ èª¤å·®åˆ†æ</h4>
      <div id="delta" class="note">â€”</div>
    </div>

    <div class="card">
      <h4 class="h4">ğŸ“Š æ¯æ—¥ç³»çµ± vs å­¸ç”Ÿè¨˜å¸³æ¯”è¼ƒ</h4>
      <div class="scroll-table">
        <table class="table">
          <thead>
            <tr>
              <th>æ—¥</th>
              <th class="pair-money">ç³»çµ± é‡‘</th>
              <th class="pair-money">å­¸ç”Ÿ é‡‘</th>
              <th class="pair-energy">ç³»çµ± é«”</th>
              <th class="pair-energy">å­¸ç”Ÿ é«”</th>
              <th class="pair-mood">ç³»çµ± å¿ƒ</th>
              <th class="pair-mood">å­¸ç”Ÿ å¿ƒ</th>
            </tr>
          </thead>
          <tbody id="dailyDiffBody"></tbody>
        </table>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <h4 class="h4">ğŸ§® ç³»çµ±æ˜ç´°ï¼ˆå¾Œå°ç´€éŒ„ï¼‰</h4>
        <div class="scroll-table">
          <table class="table" id="sysTable">
            <thead>
            <tr><th>æ—¥</th><th>æ”¶ï¼æ”¯</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>é«”</th><th>å¿ƒ</th><th>å‚™è¨»</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h4 class="h4">âœ å­¸ç”Ÿè¨˜å¸³æ˜ç´°</h4>
        <div class="scroll-table">
          <table class="table" id="stuTable">
            <thead>
            <tr><th>æ—¥</th><th>æ”¶ï¼æ”¯</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>é«”</th><th>å¿ƒ</th><th>å‚™è¨»</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="row">
      <button id="sendEnd" class="primary">é€äº¤åˆ°è¡¨å–®</button>
    </div>
  </section>

  <!-- ğŸ‘©â€ğŸ« æ•™å¸«ç«¯ -->
  <section id="page-teacher" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h3>ğŸ‘©â€ğŸ« æ•™å¸«å·¥å…·</h3>
      <div class="row">
        <input id="tpw" autocomplete="off" placeholder="æ•™å¸«ç¢¼" style="width:150px">
        <button id="tun" class="primary">è§£é–</button>
      </div>
    </div>

    <div id="tTools" class="hidden">
      <div class="card">
        <h4 class="h4">ğŸ“¨ è¡¨å–®è¨­å®š</h4>
        <p class="note">è²¼ä¸Š Google è¡¨å–® formResponse çš„ç¶²å€å‰æ®µï¼ˆå« entry= ç­‰è™Ÿï¼‰ã€‚å­¸ç”ŸæŒ‰ã€Œé€äº¤åˆ°è¡¨å–®ã€æ™‚ï¼Œç³»çµ±æœƒæŠŠ JSON æ¥åœ¨å¾Œé¢ã€‚</p>
        <div class="row">
          <input id="formURL" autocomplete="off" style="flex:1">
          <button id="saveForm" class="primary">å„²å­˜</button>
          <span id="formSaved" class="pill">â€”</span>
        </div>
      </div>

      <div class="card">
        <h4 class="h4">ğŸ§© åŒ¯ç¸½å­¸ç”Ÿå¿«ç…§</h4>
        <textarea id="agg" style="width:100%;min-height:140px" placeholder='{"key":"901-12-ç‹å°æ˜","day":4,"system":{"money":1200,"energy":80,"mood":90,"deaths":0},"student":{"money":1100,"energy":70,"mood":85,"deaths":1}}'></textarea>
        <div class="row">
          <button id="parse" class="primary">è§£æ</button>
          <button id="csvAll" class="good">ä¸‹è¼‰å…¨ç­ CSV</button>
        </div>
        <div class="scroll-table">
          <table class="table" id="aggT">
            <thead>
            <tr>
              <th>å­¸ç”Ÿ</th><th>å¤©æ•¸</th>
              <th>sys é‡‘</th><th>stu é‡‘</th>
              <th>sys é«”</th><th>stu é«”</th>
              <th>sys å¿ƒ</th><th>stu å¿ƒ</th>
              <th>sys æ­»</th><th>stu æ­»</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ä¸‹æ–¹å°è¦½ -->
<div class="sticky">
  <button data-nav="#page-cover">å°é¢</button>
  <button data-nav="#page-rules">è¦å‰‡</button>
  <button data-nav="#page-record">è¨˜å¸³</button>
  <button data-nav="#page-summary">çµç®—</button>
  <button data-nav="#page-teacher">æ•™å¸«</button>
</div>

<!-- çµæŸä»Šå¤©ï¼šåªåœ¨ã€Œè¨˜å¸³é ã€æœƒé¡¯ç¤º -->
<button id="endDay" class="fab" style="display:none;">çµæŸä»Šå¤© â–¶</button>

<script>
(function(){
  function $(s){return document.querySelector(s)}
  function $$(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
  var PFX="hy-young-v60";
  var TEACHER="127";
  var FORMKEY = PFX + ":CFG:FORM";
  var DEFAULT_FORM = "https://docs.google.com/forms/d/e/1FAIpQLScrRiYhHL2EeTVa9OOGA5k8_1FkOe3Y0Om2ezCh4jJvnFlJgA/viewform?usp=pp_url&entry.1380580179=";

  // ğŸ”Š éŸ³æ•ˆ
  var audio=null,soundOn=true;
  function ainit(){if(!audio){try{audio=new (window.AudioContext||window.webkitAudioContext)()}catch(e){}}}
  function beep(k){
    if(!soundOn)return;
    ainit();if(!audio)return;
    var o=audio.createOscillator(),g=audio.createGain();
    o.connect(g);g.connect(audio.destination);
    var t=audio.currentTime;var f=700,d=.12;
    if(k==='start')f=520;
    if(k==='card')f=760;
    if(k==='warn')f=240;
    if(k==='dead')f=160;
    if(k==='ding')f=1200;
    if(k==='cash')f=500;
    o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(.0001,t);
    g.gain.exponentialRampToValueAtTime(.2,t+.02);
    g.gain.exponentialRampToValueAtTime(.0001,t+d);
    o.start(t);o.stop(t+d+.02);
  }
  var btnSound = $('#btnSound');
  if(btnSound){
    btnSound.onclick=function(){
      soundOn=!soundOn;
      btnSound.textContent=soundOn?'ğŸ”ˆ æç¤ºéŸ³é–‹':'ğŸ”‡ æç¤ºéŸ³é—œ';
    };
  }

  function alertInfo(html){Swal.fire({icon:"info",html:html,confirmButtonText:"å¥½"});}
  function alertSuccess(html){Swal.fire({icon:"success",html:html,confirmButtonText:"å¤ªæ£’äº†ï¼"});}
  function alertWarn(html){Swal.fire({icon:"warning",html:html,confirmButtonText:"æˆ‘çŸ¥é“äº†"});}
  function alertError(html){Swal.fire({icon:"error",html:html,confirmButtonText:"å¥½"});}

  // è·æ¥­
  var JOBS=[
    {id:'mega',name:'é»‘ç´…å¤§ç¶²ç´…ï¼ˆæœ‰è–ªå‡0å¤©ï¼‰',salary:600,e:-60,m:-50,pl:0,
      desc:'æ¯å¤©éŒ„å½±ä»‹ç´¹ä¸€ç¨®è·æ¥­ï¼Œå¯«æ¨™é¡Œèˆ‡æ–‡æ¡ˆã€‚å·¥ä½œå®Œæˆå¾Œå¯æŠ½ç²‰çµ²è´ˆç¦®ã€‚è–ªè³‡ç´„ +600ï¼›é«”-60ï¼›å¿ƒ-50ã€‚'},
    {id:'eng',name:'å·¥ç¨‹å¸«',salary:500,e:-50,m:-40,pl:1,base:150,bonus:350,
      desc:'æ¯å¤©å®Œæˆä¸€å€‹ç¨‹å¼é¡Œã€‚åº•è–ª150ï¼‹çé‡‘350ï¼ˆå…±500ï¼‰ï¼›é«”-50ï¼›å¿ƒ-40ã€‚'},
    {id:'teacher',name:'è€å¸«',salary:300,e:-20,m:-40,pl:1,
      desc:'æ¯å¤©åšä¸€ä»½è¬›ç¾©ï¼é‡é»æ•´ç†ã€‚è–ªè³‡+300ï¼›é«”-20ï¼›å¿ƒ-40ã€‚'},
    {id:'admin',name:'è¡Œæ”¿äººå“¡',salary:150,e:-15,m:-20,pl:1,
      desc:'è² è²¬æ‰“å­—ã€æ•´ç†è³‡æ–™ã€‚è–ªè³‡+150ï¼›é«”-15ï¼›å¿ƒ-20ã€‚'},
    {id:'clean',name:'æ¸…æ½”äººå“¡',salary:100,e:-30,m:-30,pl:1,
      desc:'æƒåœ°ã€å€’åƒåœ¾ã€æ•´ç†ç’°å¢ƒã€‚è–ªè³‡+100ï¼›é«”-30ï¼›å¿ƒ-30ã€‚'},
    {id:'mini',name:'å°ç¶²ç´…ï¼ˆæœ‰è–ªå‡0å¤©ï¼‰',salary:80,e:-40,m:+30,pl:0,
      desc:'æ‹1å¼µåˆæ ¼æ´»å‹•ç…§ï¼‹ä¸€æ”¯èˆè¹ˆçŸ­ç‰‡ã€‚è–ªè³‡+80ï¼›é«”-40ï¼›å¿ƒ+30ã€‚'}
  ];

  var LUCKY=[
    {name:'æ’¿åˆ°éŒ¢åŒ…ä¸¦æ­¸é‚„',amt:+100,e:0,m:+10},
    {name:'æŠ½ä¸­å•†å“ç¦®åˆ¸',amt:+200,e:0,m:+15},
    {name:'èšé¤æœ‹å‹è«‹å®¢',amt:0,e:0,m:+20},
    {name:'æŠ½åˆ°å…è²»æ—…éŠåˆ¸',amt:0,e:+10,m:+30}
  ];
  var UNLUCKY=[
    {name:'ä¸‹å¤§é›¨æ²’å¸¶å‚˜',amt:-100,e:-10,m:-10},
    {name:'æ„Ÿå†’éœ€è¦çœ‹é†«ç”Ÿ',amt:-200,e:-20,m:-10},
    {name:'æ‰‹æ©Ÿå£æ‰ç¶­ä¿®',amt:-300,e:0,m:-20},
    {name:'é‘°åŒ™ä¸è¦‹æ‰¾é–åŒ ',amt:-200,e:-5,m:-10},
    {name:'é¨è…³è¸è»Šé—–ç´…ç‡ˆ',amt:-300,e:0,m:-20},
    {name:'ä¸å°å¿ƒå—å‚·ä½é™¢',amt:-400,e:-20,m:-20}
  ];

  var S={
    meta:{klass:'',no:'',name:'',day:1},
    job:null,
    tx_stu:{1:[],2:[],3:[],4:[]},
    tx_sys:{1:[],2:[],3:[],4:[]},
    formURL:DEFAULT_FORM,
    effects:{},
    counters:{},
    leave:{},
    leavePaidUsed:0,
    deathCount:0,
    deathDays:[]
  };

  // è®€å–è€å¸«è¡¨å–®ç¶²å€è¨­å®šï¼ˆè‹¥æ²’æœ‰å°±ç”¨é è¨­ï¼‰
  (function loadFormConfig(){
    try{
      var f = localStorage.getItem(FORMKEY);
      if(f){
        S.formURL = f;
      }
      var inp = document.querySelector('#formURL');
      var lab = document.querySelector('#formSaved');
      if(inp) inp.value = S.formURL || '';
      if(lab) lab.textContent = S.formURL ? 'å·²è¨­å®š' : 'â€”';
    }catch(e){}
  })();

  var giftUsed={1:false,2:false,3:false,4:false};
  var workUsed={1:false,2:false,3:false,4:false};

  function key(){return PFX+":"+(S.meta.klass||'NA')+"-"+(S.meta.no||'NA')+"-"+(S.meta.name||'NA');}
  function save(){try{localStorage.setItem(key(),JSON.stringify(S));}catch(e){}}

  // é é¢åˆ‡æ› + çµæŸä»Šå¤©æŒ‰éˆ•é¡¯ç¤ºæ§åˆ¶
  function nav(id){
    var secs=$$('main>section');
    for(var i=0;i<secs.length;i++){
      secs[i].classList.toggle('hidden','#'+secs[i].id!==id);
    }
    var showEnd = (id === '#page-record');
    var endBtn = $('#endDay');
    if(endBtn) endBtn.style.display = showEnd ? 'block' : 'none';
    location.hash=id;
  }

  function setBars(e,m){
    $('#eBar').style.width=Math.max(0,Math.min(100,e))+'%';
    $('#mBar').style.width=Math.max(0,Math.min(100,m))+'%';
    $('#eVal').textContent=Math.round(e);
    $('#mVal').textContent=Math.round(m);
  }
  function fmtSign(v){if(v===undefined||v===null)return'';return v>=0?('+'+v):v;}
  function transCat(c){
    var map={salary:'è–ªè³‡ï¼æ‰“å·¥',food:'é¤é£Ÿ',leisure:'ä¼‘é–’',bank:'éŠ€è¡Œï¼åˆ©æ¯',loan:'å€Ÿæ¬¾ï¼é‚„æ¬¾',event:'äº‹ä»¶',other:'å…¶ä»–'};
    return map[c]||c;
  }

  // è·æ¥­é¸å–®
  var jobSel=$('#job');
  jobSel.innerHTML='<option value="">â€” è«‹é¸æ“‡ â€”</option>'+JOBS.map(function(j){return'<option value="'+j.id+'">'+j.name+'</option>';}).join('');
  function renderJobBanner(){
    if(!S.job){
      $('#jobBanner').innerHTML='<div class="note">ç›®å‰å°šæœªé¸æ“‡è·æ¥­ï¼Œè«‹å…ˆå›åˆ°ã€Œå°é¢ã€é é¸è·æ¥­ã€‚</div>';
      return;
    }
    $('#jobBanner').innerHTML=
      '<div class="row"><span class="pill">ç›®å‰è·æ¥­</span><b>'+S.job.name+'</b></div>'+
      '<div class="row">'+
        '<span class="pill">æ¯æ¬¡å®Œæˆå·¥ä½œï¼šç´„ $'+S.job.salary+'</span>'+
        '<span class="pill">é«”åŠ› '+S.job.e+'</span>'+
        '<span class="pill">å¿ƒæƒ… '+S.job.m+'</span>'+
        '<span class="pill">æœ‰è–ªå‡ '+S.job.pl+' å¤©</span>'+
      '</div>';
  }
  function paintJobDesc(){
    if(!S.job){
      $('#jobNow').textContent='â€”';
      $('#jobDesc').textContent='è«‹é¸æ“‡è·æ¥­ï¼Œå³å´æœƒé¡¯ç¤ºå·¥ä½œå…§å®¹ã€è–ªè³‡ã€é«”åŠ›ï¼å¿ƒæƒ…è€—æèˆ‡æœ‰è–ªå‡å¤©æ•¸ã€‚';
      $('#jobRule').textContent='è·æ¥­ï¼šâ€”';
      $('#giftBtn').classList.add('hidden');
      renderJobBanner();
      return;
    }
    $('#jobNow').textContent=S.job.name;
    if(S.job.id==='mega')$('#giftBtn').classList.remove('hidden');else $('#giftBtn').classList.add('hidden');
    $('#jobDesc').innerHTML='<div class="pill">å·¥ä½œå…§å®¹ï¼š'+S.job.desc+'</div>'
      +'<div class="pill">æ¯æ¬¡å®Œæˆè–ªè³‡ï¼šç´„ $'+S.job.salary+'</div>'
      +'<div class="pill">é«”åŠ›è®ŠåŒ–ï¼š'+S.job.e+'</div>'
      +'<div class="pill">å¿ƒæƒ…è®ŠåŒ–ï¼š'+S.job.m+'</div>'
      +'<div class="pill">æœ‰è–ªå‡å¤©æ•¸ï¼š'+S.job.pl+'</div>';
    $('#jobRule').innerHTML='è·æ¥­ï¼š<b>'+S.job.name+'</b> ï½œ æ¯æ¬¡å®Œæˆå·¥ä½œï¼š<b>ç´„ $'+S.job.salary+'</b> ï½œ é«”åŠ› '+S.job.e+' ï½œ å¿ƒæƒ… '+S.job.m+' ï½œ æœ‰è–ªå‡å¤©æ•¸ï¼š'+S.job.pl;
    renderJobBanner();
  }
  jobSel.onchange=function(){
    var id=jobSel.value;S.job=null;
    for(var i=0;i<JOBS.length;i++){if(JOBS[i].id===id){S.job=JOBS[i];break;}}
    paintJobDesc();save();
  };

  var started=false;
  $('#start').onclick=function(){
    S.meta.klass=$('#klass').value.trim();
    S.meta.no=$('#no').value.trim();
    S.meta.name=$('#name').value.trim();
    S.meta.day=1;
    S.tx_stu={1:[],2:[],3:[],4:[]};
    S.tx_sys={1:[],2:[],3:[],4:[]};
    S.counters={1:{food:0,fun:0,draw:0},2:{food:0,fun:0,draw:0},3:{food:0,fun:0,draw:0},4:{food:0,fun:0,draw:0}};
    S.leave={};
    S.leavePaidUsed=0;
    S.deathCount=0;
    S.deathDays=[];
    giftUsed={1:false,2:false,3:false,4:false};
    workUsed={1:false,2:false,3:false,4:false};

    $('#who').textContent=S.meta.name?(S.meta.klass+"-"+S.meta.no+"-"+S.meta.name):'æœªç™»å…¥';
    $('#sid').textContent=key();

    if(!S.job && jobSel.value){
      var id=jobSel.value;for(var i=0;i<JOBS.length;i++){if(JOBS[i].id===id){S.job=JOBS[i];break;}}
    }
    save();
    $('#day').textContent=S.meta.day;
    started=false;
    paintJobDesc();
    nav('#page-rules');
  };
  $('#seeRules').onclick=function(){nav('#page-rules');};
  $('#toRecord').onclick=function(){nav('#page-record');if(!started){started=true;dayStart(true);}};

  // å­¸ç”Ÿè¨˜å¸³
  var tbody=$('#tTable tbody');
  function renderStuTable(){
    var d=S.meta.day,arr=S.tx_stu[d]||[];
    tbody.innerHTML='';
    for(var i=0;i<arr.length;i++){
      var t=arr[i];
      var tr=document.createElement('tr');
      tr.innerHTML='<td>ç¬¬'+(t.day||d)+'å¤©</td>'
        +'<td>'+(t.type==='income'?'æ”¶å…¥':'æ”¯å‡º')+'</td>'
        +'<td>'+transCat(t.cat)+'</td>'
        +'<td class="right">'+t.amt+'</td>'
        +'<td class="right">'+fmtSign(t.e)+'</td>'
        +'<td class="right">'+fmtSign(t.m)+'</td>'
        +'<td>'+(t.note||'')+'</td>'
        +'<td><button class="bad del-row" data-idx="'+i+'">åˆªé™¤</button></td>';
      tbody.appendChild(tr);
    }
  }
  tbody.addEventListener('click',function(e){
    var target=e.target;
    if(target.classList.contains('del-row')){
      var idx=parseInt(target.getAttribute('data-idx'),10);
      var d=S.meta.day;
      if(S.tx_stu[d]){S.tx_stu[d].splice(idx,1);save();renderStuTable();updateStuBarsAndDash();}
    }
  });
  function addStu(t){
    var d=S.meta.day;t.day=d;
    if(!S.tx_stu[d])S.tx_stu[d]=[];
    S.tx_stu[d].push(t);
    save();renderStuTable();updateStuBarsAndDash();
  }
  $('#add').onclick=function(){
    var rawAmt=$('#tAmt').value;
    if(rawAmt===''){alertWarn('è«‹è¼¸å…¥é‡‘é¡ï¼ˆå¯ä»¥æ˜¯ 0 ï¼‰');return;}
    var t={
      type:$('#tType').value,
      cat:$('#tCat').value,
      amt:+rawAmt,
      e:+($('#tE').value||0),
      m:+($('#tM').value||0),
      note:($('#tNote').value||'').trim(),
      ts:Date.now()
    };
    addStu(t);
    $('#tAmt').value='';$('#tE').value='';$('#tM').value='';$('#tNote').value='';
  };
  $('#clear').onclick=function(){
    if(confirm('æ¸…ç©ºä»Šæ—¥æ‰€æœ‰ç´€éŒ„ï¼Ÿ')){
      S.tx_stu[S.meta.day]=[];
      save();renderStuTable();updateStuBarsAndDash();
    }
  };

  // ğŸ•’ æœ€è¿‘ 2 ç­†ç³»çµ±ç´€éŒ„
  function updateQuickLog(){
    var d=S.meta.day;
    var arr=S.tx_sys[d]||[];
    if(!arr.length){
      $('#quickLog').textContent='ç›®å‰å°šæœªæœ‰ç´€éŒ„ã€‚ç•¶ä½ æŒ‰ä¸Šé¢çš„å¿«æ·éµã€å®Œæˆå·¥ä½œã€ç²‰çµ²è´ˆç¦®æˆ–é‡åˆ°å¼·åˆ¶æ”¯å‡ºæ™‚ï¼Œé€™è£¡æœƒé¡¯ç¤ºç•¶å¤©æœ€è¿‘ 2 ç­†å¾Œå°è¡Œç‚ºã€‚';
      return;
    }
    var len=arr.length;
    var start=Math.max(0,len-2);
    var lines=[];
    for(var i=start;i<len;i++){
      var t=arr[i];
      var idx=i+1;
      var kind=t.type==='income'?'æ”¶å…¥':'æ”¯å‡º';
      lines.push(
        'Day '+d+'ï½œç¬¬'+idx+'ç­†ï½œ'
        +kind+'ï½œ'+transCat(t.cat)
        +'ï½œ$'+t.amt
        +'ï½œé«”'+fmtSign(t.e||0)
        +'ï½œå¿ƒ'+fmtSign(t.m||0)
        +(t.note?('ï½œ'+t.note):'')
      );
    }
    $('#quickLog').innerHTML=lines.join('<br>');
  }

  // å¾Œå°ç³»çµ±å¸³
  function addSys(t){
    var d=S.meta.day;
    if(!S.tx_sys[d])S.tx_sys[d]=[];
    if(!t.ts)t.ts=Date.now();
    S.tx_sys[d].push(t);save();
    updateQuickLog();
  }

  function calcStuUpTo(day){
    var money = 1000, energy = 100, mood = 100, deaths = 0;
    for (var d = 1; d <= day; d++) {
      var arr = S.tx_stu[d] || [];
      for (var i = 0; i < arr.length; i++) {
        var t = arr[i];
        money  += (t.type === 'income' ? +t.amt : -t.amt);
        energy += t.e || 0;
        mood   += t.m || 0;
      }
      var sysDie = S.deathDays && S.deathDays.indexOf(d) !== -1;
      var stuDie = (money < 0 || energy <= 0 || mood <= 0);
      if (sysDie || stuDie) {
        deaths++;
        if (d < day) {
          money  = 1000;
          energy = 100;
          mood   = 100;
        }
      }
    }
    return {money:money,energy:energy,mood:mood,deaths:deaths};
  }
  function updateStuBarsAndDash(){
    var r=calcStuUpTo(S.meta.day);
    setBars(r.energy,r.mood);
    $('#dashMoney').textContent=Math.round(r.money);
    $('#dashE').textContent=Math.round(r.energy);
    $('#dashM').textContent=Math.round(r.mood);
  }

  function calcSysEndState(day){
    var money=1000,energy=100,mood=100;
    var deaths = S.deathDays||[];
    for(var d=1;d<=day;d++){
      var arr=S.tx_sys[d]||[];
      for(var i=0;i<arr.length;i++){
        var t=arr[i];
        money+=(t.type==='income'?+t.amt:-t.amt);
        energy+=t.e||0;
        mood+=t.m||0;
      }
      if(deaths.indexOf(d)!==-1 && d<day){
        money=1000;energy=100;mood=100;
      }
    }
    return {money:money,energy:energy,mood:mood};
  }

  function getStartStateForDay(d){
    if(d===1)return{money:1000,energy:100,mood:100};
    var prevDay=d-1;
    var endPrev=calcSysEndState(prevDay);
    if(S.deathDays && S.deathDays.indexOf(prevDay)!==-1){
      return {money:1000,energy:100,mood:100};
    }
    return endPrev;
  }

  function calcSysAllForPayload(){
    var r=calcSysEndState(4);
    return{
      money:r.money,
      energy:r.energy,
      mood:r.mood,
      deaths:S.deathCount||0
    };
  }

  var LIMITS={food:3,fun:2,draw:2};
  function canUse(kind){
    var d=S.meta.day,c=S.counters[d]||{food:0,fun:0,draw:0};
    if(kind==='fun'&&S.leave[d])return true;
    if(c[kind]===undefined)return true;
    if(c[kind]>=LIMITS[kind]){
      alertWarn('ä»Šå¤©çš„ã€Œ'+(kind==='food'?'é¤é£Ÿ':kind==='fun'?'ä¼‘é–’':'æŠ½å¡')+'ã€å·²é”ä¸Šé™ã€‚');
      return false;
    }
    return true;
  }
  function used(kind){
    var d=S.meta.day;
    if(!S.counters[d])S.counters[d]={food:0,fun:0,draw:0};
    S.counters[d][kind]++;save();
  }

  // å·¥ä½œæŒ‰éˆ•ç‹€æ…‹
  function updateWorkButton(){
    var d=S.meta.day,leave=S.leave[d],usedW=workUsed[d];
    var btn=$('#work');
    if(leave){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ä»Šå¤©å·²è«‹å‡';
    }else if(usedW){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ä»Šæ—¥å·²å®Œæˆå·¥ä½œ ğŸ’¼';
    }else{
      btn.disabled=false;
      btn.style.opacity='1';
      btn.textContent='å®Œæˆå·¥ä½œï¼ˆæ•™å¸«èªè­‰ï¼‰';
    }
  }

  $('#leavePaid').onclick=function(){
    var d=S.meta.day;
    if(workUsed[d]){alertWarn('ä»Šå¤©å·²å®Œæˆå·¥ä½œï¼Œä¸èƒ½å†è«‹å‡ã€‚');return;}
    if(S.leave[d]){alertWarn('ä»Šå¤©å·²ç¶“æœ‰è«‹å‡ç´€éŒ„ï¼Œç„¡æ³•é‡è¤‡è¨­å®šã€‚');return;}
    if(!S.job){alertWarn('è«‹å…ˆé¸æ“‡è·æ¥­æ‰èƒ½ç®—æœ‰è–ªå‡å¤©æ•¸ã€‚');return;}
    if(S.job.pl===0){alertWarn('æ­¤è·æ¥­æ²’æœ‰æœ‰è–ªå‡ã€‚');return;}
    if(S.leavePaidUsed>=S.job.pl){alertWarn('å·²ç”¨å®Œæ‰€æœ‰æœ‰è–ªå‡å¤©æ•¸ã€‚');return;}
    S.leave[d]='paid';S.leavePaidUsed++;save();updateWorkButton();
    var basePay = (S.job.id==='eng' ? (S.job.base||150) : S.job.salary);
    addSys({type:'income',cat:'salary',amt:basePay,e:+10,m:+10,note:'æœ‰è–ªå‡'});
    alertInfo('ä»Šå¤©æ˜¯ã€Œæœ‰è–ªå‡ã€ã€‚<br>è«‹åˆ°è¨˜å¸³é¢æ¿è¼¸å…¥ä¸€ç­†ï¼š<br>'
      +'æ”¶ï¼æ”¯ï¼šæ”¶å…¥ï¼›é¡åˆ¥ï¼šè–ªè³‡ï¼æ‰“å·¥ï¼›<br>'
      +'é‡‘é¡ï¼šç´„ $'+basePay+'ï¼›é«”åŠ› +10ï¼›å¿ƒæƒ… +10ã€‚<br>'
      +'ï¼ˆä»Šæ—¥ä¼‘é–’æ´»å‹•æ¬¡æ•¸ä¸é™ï¼‰');
  };
  $('#leaveUnpaid').onclick=function(){
    var d=S.meta.day;
    if(workUsed[d]){alertWarn('ä»Šå¤©å·²å®Œæˆå·¥ä½œï¼Œä¸èƒ½å†è«‹å‡ã€‚');return;}
    if(S.leave[d]){alertWarn('ä»Šå¤©å·²ç¶“æœ‰è«‹å‡ç´€éŒ„ï¼Œç„¡æ³•é‡è¤‡è¨­å®šã€‚');return;}
    S.leave[d]='unpaid';save();updateWorkButton();
    addSys({type:'income',cat:'salary',amt:0,e:+10,m:+20,note:'ç„¡è–ªå‡'});
    alertInfo('ä»Šå¤©æ˜¯ã€Œç„¡è–ªå‡ã€ï¼Œæ²’æœ‰è–ªæ°´ã€ä¼‘é–’ä¸é™æ¬¡ã€‚<br>'
      +'å»ºè­°åˆ°è¨˜å¸³é¢æ¿è¼¸å…¥ï¼š<br>'
      +'æ”¶ï¼æ”¯ï¼šæ”¶å…¥ï¼›é¡åˆ¥ï¼šè–ªè³‡ï¼æ‰“å·¥ï¼›é‡‘é¡ï¼š0ï¼›é«”åŠ› +10ï¼›å¿ƒæƒ… +20ã€‚');
  };

  // ç²‰çµ²è´ˆç¦®æŒ‰éˆ•ç‹€æ…‹
  function updateGiftButtonForDay(){
    var d=S.meta.day;
    var btn=$('#giftBtn');
    if(!S.job || S.job.id!=='mega'){
      btn.classList.add('hidden');
      return;
    }
    btn.classList.remove('hidden');

    if(S.leave[d]==='unpaid'){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ç„¡è–ªå‡ç•¶å¤©ç„¡æ³•é ˜ç¦®ç‰©';
      return;
    }

    if(!workUsed[d]){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='éœ€å…ˆå®Œæˆä»Šæ—¥å·¥ä½œ';
      return;
    }

    if(giftUsed[d]){
      btn.disabled=true;
      btn.style.opacity='0.6';
      btn.textContent='ä»Šæ—¥å·²é ˜å– ğŸ';
    }else{
      btn.disabled=false;
      btn.style.opacity='1';
      btn.textContent='ç²‰çµ²è´ˆç¦®ï¼ˆå¤§ç¶²ç´…ï¼‰';
    }
  }

  $('#giftBtn').onclick=function(){
    if(!S.job || S.job.id!=='mega'){
      alertWarn('åªæœ‰ã€Œé»‘ç´…å¤§ç¶²ç´…ã€å¯ä»¥ä½¿ç”¨ç²‰çµ²è´ˆç¦®å–”ï¼');
      return;
    }
    var d=S.meta.day;
    if(S.leave && S.leave[d]==='unpaid'){
      alertWarn('ä»Šå¤©ä½ è«‹äº†ã€Œç„¡è–ªå‡ã€ï¼Œç²‰çµ²ä¹Ÿæš«æ™‚æ²’æœ‰æ–—å…§å–”ï½<br>æ˜å¤©åŠªåŠ›å·¥ä½œå†è©¦è©¦çœ‹ï¼');
      return;
    }
    if(!workUsed[d]){
      alertWarn('ä»Šå¤©é‚„æ²’å®Œæˆå·¥ä½œï¼Œç²‰çµ²é‚„åœ¨è§€æœ›ã€‚<br>å…ˆå®Œæˆå·¥ä½œï¼Œå†çœ‹çœ‹æœ‰æ²’æœ‰ç¦®ç‰©å§ï¼');
      return;
    }
    if(giftUsed[d]){
      alertInfo('ä»Šå¤©ç²‰çµ²å·²ç¶“é€éç¦®ç‰©å›‰ï¼Œæ˜å¤©å†æœŸå¾…æ–°çš„æ–—å…§ï¼');
      return;
    }
    giftUsed[d]=true;
    var gifts=Math.floor(Math.random()*11);
    var total=gifts*20;
    if(gifts===0){
      updateGiftButtonForDay();
      alertInfo('ä»Šå¤©æš«æ™‚æ²’æœ‰ç²‰çµ²æ–—å…§ï¼Œæ˜å¤©å†æ¥å†å²ï¼');
      return;
    }
    addSys({type:'income',cat:'event',amt:total,e:0,m:0,note:'ç²‰çµ²è´ˆç¦® '+gifts+' å€‹'});
    beep('ding');
    alertSuccess('æ­å–œä½ ï½ç²å¾—ç²‰çµ²æ–—å…§ <b>'+gifts+'</b> å€‹ç¦®ç‰©ï¼Œç¸½å…± <b>'+total+'</b> å…ƒï¼');
    updateGiftButtonForDay();
  };

  // ğŸ” è€å¸«é‡‘éŒ¢æ“ä½œï¼ˆå€Ÿæ¬¾ï¼é‚„æ¬¾ã€æŠ•è³‡ã€æ´»å­˜ï¼‰
  function teacherMoneyOp(kind){
    var titleMap={
      loan:'å€Ÿæ¬¾ï¼é‚„æ¬¾',
      invest:'æŠ•è³‡',
      saving:'æ´»å­˜'
    };
    var instMap={
      loan:'è«‹è€å¸«è¼¸å…¥æœ¬æ¬¡é‡‘é¡èˆ‡æ•™å¸«å¯†ç¢¼ï¼Œå”åŠ©è¨˜éŒ„ã€Œå‘æ°‘é–“æ©Ÿæ§‹ã€å€Ÿæ¬¾æˆ–é‚„æ¬¾ã€‚',
      invest:'è«‹è€å¸«è¼¸å…¥æœ¬æ¬¡é‡‘é¡èˆ‡æ•™å¸«å¯†ç¢¼ï¼Œå”åŠ©è¨˜éŒ„ã€Œå‘æ°‘é–“æ©Ÿæ§‹ã€æŠ•è³‡çš„æŠ•å…¥æˆ–æœ¬åˆ©å’Œã€‚',
      saving:'è«‹è€å¸«è¼¸å…¥æœ¬æ¬¡é‡‘é¡èˆ‡æ•™å¸«å¯†ç¢¼ï¼Œå”åŠ©è¨˜éŒ„ã€ŒéŠ€è¡Œã€æ´»å­˜çš„å­˜å…¥æˆ–æœ¬åˆ©å’Œã€‚'
    };
    Swal.fire({
      title:titleMap[kind],
      html:
        '<p>'+instMap[kind]+'</p>'+
        '<input id="sw-amt" class="swal2-input" type="number" min="1" placeholder="é‡‘é¡ï¼ˆæ­£æ•¸ï¼‰">'+
        '<input id="sw-pw" class="swal2-input" type="password" placeholder="æ•™å¸«å¯†ç¢¼">',
      focusConfirm:false,
      showCancelButton:true,
      confirmButtonText:'ä¸‹ä¸€æ­¥',
      cancelButtonText:'å–æ¶ˆ',
      preConfirm:function(){
        var a=document.getElementById('sw-amt').value;
        var pw=document.getElementById('sw-pw').value;
        var n=+a;
        if(!a || isNaN(n) || n<=0){
          Swal.showValidationMessage('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„é‡‘é¡');
          return false;
        }
        if(pw.trim()!==TEACHER){
          Swal.showValidationMessage('æ•™å¸«å¯†ç¢¼éŒ¯èª¤');
          return false;
        }
        return {amount:Math.round(n)};
      }
    }).then(function(res){
      if(!res.isConfirmed)return;
      var amt=res.value.amount;
      var d=S.meta.day;

      if(kind==='loan'){
        Swal.fire({
          title:'å€Ÿæ¬¾æˆ–é‚„æ¬¾',
          html:
            'è«‹é¸æ“‡è¦è¨˜éŒ„çš„é …ç›®ï¼š<br><br>'+
            'âœ… <b>å€Ÿæ¬¾</b>ï¼šå‘æ°‘é–“æ©Ÿæ§‹å€ŸéŒ¢ï¼Œé‡‘é¡æœƒåŠ åˆ°ç©å®¶èº«ä¸Šï¼ˆæ”¶å…¥ï¼‰ã€‚<br>'+
            'âœ… <b>é‚„æ¬¾</b>ï¼šå‘æ°‘é–“æ©Ÿæ§‹é‚„éŒ¢ï¼Œé‡‘é¡æœƒå¾ç©å®¶èº«ä¸Šæ‰£é™¤ï¼ˆæ”¯å‡ºï¼‰ã€‚<br><br>'+
            'è©³ç´°åˆ©ç‡èˆ‡æ¢ä»¶è«‹æ‰¾ã€Œæ°‘é–“æ©Ÿæ§‹ã€è™•ç†ã€‚',
          showDenyButton:true,
          showCancelButton:true,
          confirmButtonText:'å€Ÿæ¬¾ï¼ˆæ”¶å…¥ï¼‰',
          denyButtonText:'é‚„æ¬¾ï¼ˆæ”¯å‡ºï¼‰',
          cancelButtonText:'å–æ¶ˆ'
        }).then(function(ch){
          if(ch.isConfirmed){
            // å€Ÿæ¬¾ï¼šæ”¶å…¥ +amt
            addSys({
              type:'income',
              cat:'loan',
              amt:amt,
              e:0,m:0,
              note:'å‘æ°‘é–“æ©Ÿæ§‹å€Ÿæ¬¾ '+amt+' å…ƒ'
            });
            beep('cash');
            alertSuccess('å·²è¨˜éŒ„ï¼šå‘æ°‘é–“æ©Ÿæ§‹å€Ÿæ¬¾ '+amt+' å…ƒï¼ˆæ”¶å…¥ï¼‰ã€‚');
          }else if(ch.isDenied){
            // é‚„æ¬¾ï¼šæ”¯å‡º -amt
            addSys({
              type:'expense',
              cat:'loan',
              amt:amt,
              e:0,m:0,
              note:'å‘æ°‘é–“æ©Ÿæ§‹é‚„æ¬¾ '+amt+' å…ƒ'
            });
            beep('cash');
            alertSuccess('å·²è¨˜éŒ„ï¼šå‘æ°‘é–“æ©Ÿæ§‹é‚„æ¬¾ '+amt+' å…ƒï¼ˆæ”¯å‡ºï¼‰ã€‚');
          }
        });
      }

      if(kind==='invest'){
        Swal.fire({
          title:'æŠ•è³‡ï¼šæŠ•å…¥æˆ–æœ¬åˆ©å’Œ',
          html:
            'è«‹é¸æ“‡è¦è¨˜éŒ„çš„é …ç›®ï¼š<br><br>'+
            'âœ… <b>æŠ•å…¥é‡‘é¡</b>ï¼šæŠŠéŒ¢æ‹¿å»æŠ•è³‡ï¼Œé‡‘é¡æœƒå¾ç©å®¶èº«ä¸Šæ‰£é™¤ï¼ˆæ”¯å‡ºï¼‰ã€‚<br>'+
            'âœ… <b>æœ¬åˆ©å’Œ</b>ï¼šæŠ•è³‡çµæŸæ‹¿å›æœ¬åˆ©å’Œï¼Œé‡‘é¡æœƒåŠ åˆ°ç©å®¶èº«ä¸Šï¼ˆæ”¶å…¥ï¼‰ã€‚<br><br>'+
            'å¯¦éš›æŠ•è³‡å•†å“èˆ‡é¢¨éšªï¼Œè«‹æ‰¾ã€Œæ°‘é–“æ©Ÿæ§‹ã€è™•ç†ã€‚',
          showDenyButton:true,
          showCancelButton:true,
          confirmButtonText:'æŠ•å…¥é‡‘é¡ï¼ˆæ”¯å‡ºï¼‰',
          denyButtonText:'æœ¬åˆ©å’Œï¼ˆæ”¶å…¥ï¼‰',
          cancelButtonText:'å–æ¶ˆ'
        }).then(function(ch){
          if(ch.isConfirmed){
            // æŠ•å…¥é‡‘é¡ï¼šæ”¯å‡º -amt
            addSys({
              type:'expense',
              cat:'bank',
              amt:amt,
              e:0,m:0,
              note:'æŠ•è³‡æŠ•å…¥é‡‘é¡ '+amt+' å…ƒï¼ˆè«‹å‘æ°‘é–“æ©Ÿæ§‹ç¢ºèªï¼‰'
            });
            beep('cash');
            alertSuccess('å·²è¨˜éŒ„ï¼šæŠ•è³‡æŠ•å…¥ '+amt+' å…ƒï¼ˆæ”¯å‡ºï¼‰ã€‚');
          }else if(ch.isDenied){
            // æœ¬åˆ©å’Œï¼šæ”¶å…¥ +amt
            addSys({
              type:'income',
              cat:'bank',
              amt:amt,
              e:0,m:0,
              note:'æŠ•è³‡æœ¬åˆ©å’Œ '+amt+' å…ƒï¼ˆè«‹å‘æ°‘é–“æ©Ÿæ§‹ç¢ºèªï¼‰'
            });
            beep('cash');
            alertSuccess('å·²è¨˜éŒ„ï¼šæŠ•è³‡æœ¬åˆ©å’Œ '+amt+' å…ƒï¼ˆæ”¶å…¥ï¼‰ã€‚');
          }
        });
      }

      if(kind==='saving'){
        Swal.fire({
          title:'æ´»å­˜ï¼šå­˜å…¥æˆ–æœ¬åˆ©å’Œ',
          html:
            'è«‹é¸æ“‡è¦è¨˜éŒ„çš„é …ç›®ï¼š<br><br>'+
            'âœ… <b>æŠ•å…¥é‡‘é¡</b>ï¼šæŠŠéŒ¢å­˜å…¥éŠ€è¡Œæ´»å­˜ï¼Œé‡‘é¡æœƒå¾ç©å®¶èº«ä¸Šæ‰£é™¤ï¼ˆæ”¯å‡ºï¼‰ã€‚<br>'+
            'âœ… <b>æœ¬åˆ©å’Œ</b>ï¼šæ´»å­˜è§£ç´„æˆ–é ˜å‡ºæœ¬åˆ©å’Œï¼Œé‡‘é¡æœƒåŠ åˆ°ç©å®¶èº«ä¸Šï¼ˆæ”¶å…¥ï¼‰ã€‚<br><br>'+
            'å¯¦éš›åˆ©ç‡èˆ‡è¦å‰‡ï¼Œè«‹æ‰¾ã€ŒéŠ€è¡Œã€è™•ç†ã€‚',
          showDenyButton:true,
          showCancelButton:true,
          confirmButtonText:'æŠ•å…¥é‡‘é¡ï¼ˆæ”¯å‡ºï¼‰',
          denyButtonText:'æœ¬åˆ©å’Œï¼ˆæ”¶å…¥ï¼‰',
          cancelButtonText:'å–æ¶ˆ'
        }).then(function(ch){
          if(ch.isConfirmed){
            // æ´»å­˜å­˜å…¥ï¼šæ”¯å‡º -amt
            addSys({
              type:'expense',
              cat:'bank',
              amt:amt,
              e:0,m:0,
              note:'æ´»å­˜å­˜å…¥ '+amt+' å…ƒï¼ˆè«‹å‘éŠ€è¡Œç¢ºèªï¼‰'
            });
            beep('cash');
            alertSuccess('å·²è¨˜éŒ„ï¼šæ´»å­˜å­˜å…¥ '+amt+' å…ƒï¼ˆæ”¯å‡ºï¼‰ã€‚');
          }else if(ch.isDenied){
            // æ´»å­˜æœ¬åˆ©å’Œï¼šæ”¶å…¥ +amt
            addSys({
              type:'income',
              cat:'bank',
              amt:amt,
              e:0,m:0,
              note:'æ´»å­˜æœ¬åˆ©å’Œ '+amt+' å…ƒï¼ˆè«‹å‘éŠ€è¡Œç¢ºèªï¼‰'
            });
            beep('cash');
            alertSuccess('å·²è¨˜éŒ„ï¼šæ´»å­˜æœ¬åˆ©å’Œ '+amt+' å…ƒï¼ˆæ”¶å…¥ï¼‰ã€‚');
          }
        });
      }

    });
  }

  $('#loanBtn').onclick=function(){teacherMoneyOp('loan');};
  $('#investBtn').onclick=function(){teacherMoneyOp('invest');};
  $('#savingBtn').onclick=function(){teacherMoneyOp('saving');};

  // é¤é£Ÿ
  $('#food0').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:0,e:-20,m:-15,note:'ä¸åƒé£¯'});used('food');beep('cash');alertInfo('ğŸ½ ä¸åƒé£¯ â†’ é«”-20ï¼Œå¿ƒ-15');};
  $('#food1').onclick=function(){if(!canUse('food'))return;if(!canUse('fun'))return;addSys({type:'expense',cat:'food',amt:100,e:+20,m:+10,note:'è‡ªå·±å‚™é¤'});used('food');used('fun');beep('cash');alertInfo('ğŸ± è‡ªå·±å‚™é¤ -100ï¼Œé«”+20ï¼Œå¿ƒ+10ï¼ˆå  1 æ¬¡ä¼‘é–’é¡åº¦ï¼‰');};
  $('#food2').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:100,e:+15,m:+10,note:'è·¯é‚Šæ”¤'});used('food');beep('cash');alertInfo('ğŸ¥Ÿ è·¯é‚Šæ”¤ -100ï¼Œé«”+15ï¼Œå¿ƒ+10');};
  $('#food3').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:200,e:+30,m:+0,note:'å¥åº·é¤ç›’'});used('food');beep('cash');alertInfo('ğŸ¥— å¥åº·é¤ç›’ -200ï¼Œé«”+30ï¼Œå¿ƒ+0');};
  $('#food4').onclick=function(){if(!canUse('food'))return;addSys({type:'expense',cat:'food',amt:300,e:+10,m:+20,note:'å¥¢ä¾ˆé€Ÿé£Ÿ'});used('food');beep('cash');alertInfo('ğŸ” å¥¢ä¾ˆé€Ÿé£Ÿ -300ï¼Œé«”+10ï¼Œå¿ƒ+20');};

  // ä¼‘é–’
  $('#fun0').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:200,e:-10,m:+20,note:'çœ‹é›»å½±'});used('fun');beep('ok');alertInfo('ğŸ¬ çœ‹é›»å½± -200ï¼Œé«”-10ï¼Œå¿ƒ+20');};
  $('#fun1').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:50,e:-10,m:+15,note:'æ‰“é›»å‹•'});used('fun');beep('ok');alertInfo('ğŸ•¹ æ‰“é›»å‹• -50ï¼Œé«”-10ï¼Œå¿ƒ+15');};
  $('#fun2').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:250,e:-10,m:+25,note:'èšé¤'});used('fun');beep('ok');alertInfo('ğŸ» èšé¤ -250ï¼Œé«”-10ï¼Œå¿ƒ+25');};
  $('#fun3').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:10,e:-25,m:+15,note:'é‹å‹•'});used('fun');beep('ok');alertInfo('ğŸƒ é‹å‹• -10ï¼Œé«”-25ï¼Œå¿ƒ+15');};
  $('#fun4').onclick=function(){if(!canUse('fun'))return;addSys({type:'expense',cat:'leisure',amt:100,e:-5,m:+10,note:'ç•«ç•«ï¼è®€æ›¸'});used('fun');beep('ok');alertInfo('ğŸ¨ ç•«ç•«ï¼è®€æ›¸ -100ï¼Œé«”-5ï¼Œå¿ƒ+10');};

  function applyFx(base,fx){return Math.round(base*fx);}

  // ğŸ’¼ å·¥ä½œï¼šæ¯å¤©ä¸€æ¬¡
  $('#work').onclick=function(){
    if(!S.job){alertWarn('å°šæœªé¸æ“‡è·æ¥­ï¼Œè«‹å›åˆ°å°é¢é¸è·æ¥­ã€‚');return;}
    var d=S.meta.day;
    if(S.leave[d]){alertWarn('ä»Šå¤©å·²è«‹å‡ï¼Œä¸èƒ½ä¸Šç­ã€‚');return;}
    if(workUsed[d]){
      alertInfo('ä»Šå¤©å·²å®Œæˆå·¥ä½œï¼Œæ˜å¤©å†ä¸Šç­å°±å¥½ã€‚');
      return;
    }

    var eff=S.effects[d]||{},fx=eff.fxHint||1;
    Swal.fire({
      title:'æ•™å¸«èªè­‰',
      html:'å·¥ä½œï¼š'+S.job.name+'<br>'
          +'åŸå§‹è–ªè³‡ç´„ $'+S.job.salary+'<br>'
          +'é«”åŠ› '+S.job.e+'ï¼Œå¿ƒæƒ… '+S.job.m+'<br>'
          +'ä»Šæ—¥è–ªæ°´å€ç‡ï¼š<b>x '+fx.toFixed(2)+'</b>',
      input:'password',
      inputPlaceholder:'è«‹ç”±è€å¸«è¼¸å…¥å¯†ç¢¼',
      showCancelButton:true,
      confirmButtonText:'ç¢ºèª',
      cancelButtonText:'å–æ¶ˆ'
    }).then(function(pw){
      if(!pw.isConfirmed)return;
      if((pw.value||'').trim()!==TEACHER){alertError('æ•™å¸«å¯†ç¢¼éŒ¯èª¤');return;}

      if(S.job.id==='eng'){
        Swal.fire({
          title:'å·¥ç¨‹å¸«è–ªè³‡é¸æ“‡',
          html:'è«‹é¸æ“‡ä»Šæ—¥çµ¦è–ªæ–¹å¼ï¼š',
          showDenyButton:true,
          confirmButtonText:'åº•è–ª150ï¼‹çé‡‘350ï¼ˆ500ï¼‰',
          denyButtonText:'åƒ…åº•è–ª 150'
        }).then(function(ch){
          var base, payNote;
          if(ch.isDenied){base=S.job.base||150;payNote='ï¼ˆåƒ…åº•è–ªï¼‰';}
          else{base=(S.job.base||150)+(S.job.bonus||350);payNote='ï¼ˆåº•è–ªï¼‹çé‡‘ï¼‰';}
          var finalPay=applyFx(base,fx);
          addSys({type:'income',cat:'salary',amt:finalPay,e:S.job.e,m:S.job.m,
            note:'å®Œæˆå·¥ä½œ-'+S.job.name+payNote+'ï½œåŸå§‹ '+base+' Ã—'+fx.toFixed(2)+' â†’ '+finalPay});
          workUsed[d]=true;save();
          updateWorkButton();
          updateGiftButtonForDay();
          beep('ding');
          alertSuccess(
            'ğŸ’¼ å®Œæˆå·¥ä½œï¼<br>'
            +'åŸå§‹è–ªè³‡ï¼š$'+base+' '+payNote+'<br>'
            +'å€ç‡ï¼šx '+fx.toFixed(2)+' â†’ å¯¦éš›å…¥å¸³ <b>$'+finalPay+'</b><br>'
            +'é«”åŠ›'+S.job.e+'ã€å¿ƒæƒ…'+S.job.m+' å·²è¨˜å…¥ç³»çµ±ã€‚'
          );
        });
      }else{
        var base=S.job.salary;
        var finalPay=applyFx(base,fx);
        addSys({type:'income',cat:'salary',amt:finalPay,e:S.job.e,m:S.job.m,
          note:'å®Œæˆå·¥ä½œ-'+S.job.name+'ï½œåŸå§‹ '+base+' Ã—'+fx.toFixed(2)+' â†’ '+finalPay});
        workUsed[d]=true;save();
        updateWorkButton();
        updateGiftButtonForDay();
        beep('ding');
        alertSuccess(
          'ğŸ’¼ å®Œæˆå·¥ä½œï¼<br>'
          +'åŸå§‹è–ªè³‡ï¼š$'+base+'<br>'
          +'å€ç‡ï¼šx '+fx.toFixed(2)+' â†’ å¯¦éš›å…¥å¸³ <b>$'+finalPay+'</b><br>'
          +'é«”åŠ›'+S.job.e+'ã€å¿ƒæƒ…'+S.job.m+' å·²è¨˜å…¥ç³»çµ±ã€‚'
        );
      }
    });
  };

  // æŠ½äº‹ä»¶å¡
  $('#btnDraw').onclick=function(){
    var d=S.meta.day;
    if(d!==1 && d!==3){
      alertWarn('åªæœ‰ç¬¬ 1 å¤©èˆ‡ç¬¬ 3 å¤©å¯ä»¥æŠ½äº‹ä»¶å¡ã€‚');
      return;
    }
    if(!canUse('draw'))return;

    var isLucky=Math.random()<0.5;
    var deck=isLucky?LUCKY:UNLUCKY;
    var kind=isLucky?'å¹¸é‹':'ä¸å¹¸';
    var p=deck[Math.floor(Math.random()*deck.length)];
    addSys({
      type:(p.amt>=0?'income':'expense'),
      cat:'event',
      amt:Math.abs(p.amt),
      e:p.e||0,
      m:p.m||0,
      note:kind+'ï¼š'+p.name
    });
    used('draw');beep('card');
    alertInfo(kind+'äº‹ä»¶ï¼š'+p.name+'<br>é‡‘é¡ '+(p.amt>=0?'+':'')+p.amt+'ï½œé«”'+fmtSign(p.e||0)+'ï½œå¿ƒ'+fmtSign(p.m||0));
  };

  function deathMsg(f){
    if (f.e && f.m && f.$) {
      return "â˜ ï¸ é‡‘éŒ¢è¦‹åº•ã€é«”åŠ›è€—ç›¡ã€å¿ƒæƒ…å´©æ½°ï¼Œä½ æ•´å€‹çˆ†ç‚¸åªå¥½é‡ä¾†ã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
    }
    if (f.e && f.m) {
      return "â˜ ï¸ é«”åŠ›æ­¸ 0 åˆå¿ƒæƒ…æ­¸ 0ï¼Œè¢«é€å»é•·æœŸä¼‘é¤Šï¼Œåªå¥½é‡å•Ÿäººç”Ÿã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
    }
    if (f.e && f.$) {
      return "âš ï¸ é«”åŠ›é€æ”¯åˆæ²’éŒ¢çœ‹é†«ç”Ÿï¼Œä½ è¢«å¼·åˆ¶ä¸­æ­¢æ´»å‹•ä¸¦é‡ç½®ç‹€æ…‹ã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
    }
    if (f.m && f.$) {
      return "ğŸ’” å¿ƒæƒ…è·Œåˆ°è°·åº•åˆé™·å…¥è² å‚µï¼Œä½ æ±ºå®šå…ˆæŠŠäººç”Ÿé‡é–‹ä¸€æ¬¡ã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
    }
    if (f.e) {
      return "âš ï¸ é«”åŠ›æ­¸ 0ï¼Œä½ ç›´æ¥å€’ä¸‹é€é†«ä¼‘é¤Šï¼Œç‹€æ…‹é‡ç½®ã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
    }
    if (f.m) {
      return "ğŸ’” å¿ƒæƒ…æ­¸ 0ï¼Œä»€éº¼äº‹éƒ½åšä¸ä¸‹å»ï¼Œåªå¥½æš«åœé‡ä¾†ã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
    }
    return "ğŸ’¸ é‡‘éŒ¢è®Šæˆè² æ•¸ï¼Œç„¡æ³•æ”¯ä»˜æ—¥å¸¸é–‹éŠ·ï¼Œè¢«è¿«é‡æ–°è¦åŠƒã€‚æ­»äº¡æ¬¡æ•¸ +1ã€‚";
  }

  // ğŸŒ… æ¯å¤©é–‹å§‹
  function dayStart(first){
    var d=S.meta.day;
    $('#day').textContent=d;
    beep('start');
    if(!S.counters[d])S.counters[d]={food:0,fun:0,draw:0};
    paintJobDesc();

    var diedYesterday = S.deathDays && S.deathDays.indexOf(d-1)!==-1;
    var title = diedYesterday
      ? 'â˜ ï¸ æ­»äº¡é‡ç”Ÿå¾Œçš„æ–°ä¸€å¤©ï½œDay '+d
      : 'ğŸŒ… æ–°çš„ä¸€å¤©é–‹å§‹ï½œDay '+d;

    var html='<h3>'+title+'</h3>';

    if(diedYesterday){
      html+='<p>æ˜¨å¤©æœ‰ç™¼ç”Ÿã€Œæ­»äº¡é‡ç”Ÿã€ï¼Œ<br>ä»Šå¤©èµ·å§‹å€¼å·²é‡ç½®ç‚ºï¼šé‡‘ 1000ï¼Œé«” 100ï¼Œå¿ƒ 100ã€‚</p>';
    }

    html+='<p>ä»Šæ—¥è¦åšçš„äº‹ï¼š</p>'
      +'<ul style="text-align:left;display:inline-block;">'
      +'<li>â‘  ä¸Šç­æˆ–è«‹å‡ã€‚</li>'
      +'<li>â‘¡ åƒé£¯ 1ï½3 æ¬¡ã€‚</li>'
      +'<li>â‘¢ åš 1ï½2 å€‹ä¼‘é–’æ´»å‹•ã€‚</li>'
      +'<li>â‘£ Day1ã€3 å¯æŠ½äº‹ä»¶å¡ã€‚</li>'
      +'<li>â‘¤ Day2ã€4 æœ‰å›ºå®šæ”¯å‡ºï¼Œè¦é ç•™ç¾é‡‘ã€‚</li>'
      +'</ul>';

    var prev=getStartStateForDay(d);
    var fxHint=1,statusNote='';
    if(prev.energy>110){fxHint*=1.5;statusNote+='ğŸ’ª é«”åŠ› &gt;110ï¼šè–ªæ°´ Ã—1.5<br>';}
    if(prev.energy<50){fxHint*=0.5;statusNote+='ğŸ˜µ é«”åŠ› &lt;50ï¼šè–ªæ°´ Ã·2ï¼ˆéå‹ï¼‰<br>';}
    if(prev.mood>110){fxHint*=1.5;statusNote+='ğŸ˜„ å¿ƒæƒ… &gt;110ï¼šè–ªæ°´ Ã—1.5<br>';}
    if(prev.mood<30){fxHint*=0.5;statusNote+='ğŸ˜ å¿ƒæƒ… &lt;30ï¼šè–ªæ°´ Ã·2ï¼ˆä½è½ï¼‰<br>';}

    S.effects[d]={fxHint:fxHint};save();
    if(statusNote)html+='<hr><p>'+statusNote+'</p>';

    html+='<hr><p>ğŸ“˜ <b>ä»Šæ—¥è¨˜å¸³æé†’ï¼š</b><br>'
         +'æ¯åšä¸€ä»¶äº‹ï¼Œå°±åˆ°ä¸‹æ–¹è¨˜å¸³é¢æ¿å¡«é‡‘é¡ï¼‹é«”åŠ›ï¼‹å¿ƒæƒ…ã€‚<br>'
         +'å¿˜è¨˜è¨˜ï¼Œå¾ˆå®¹æ˜“è·Ÿç³»çµ±å·®å¾ˆå¤šå–”ï¼</p>';

    if(d===1||d===3)html+='<p>ğŸ² ä»Šå¤©å¯æŠ½å‘½é‹äº‹ä»¶å¡ï¼ˆå»ºè­° 1ï½2 æ¬¡ï¼‰ã€‚</p>';
    if(d===2){
      addSys({type:'expense',cat:'event',amt:250,e:0,m:0,note:'å¼·åˆ¶ï¼šç¹³ç­è²»'});
      html+='<p>ğŸ“Œ ä»Šæ—¥å›ºå®šæ”¯å‡ºï¼šã€Œç¹³ç­è²» 250 å…ƒã€ï¼Œç³»çµ±å·²è‡ªå‹•æ‰£æ¬¾ã€‚</p>';
    }
    if(d===4){
      addSys({type:'expense',cat:'event',amt:150,e:0,m:0,note:'å¼·åˆ¶ï¼šæ°´é›»è²»ï¼å†·æ°£å„²å€¼'});
      html+='<p>ğŸ“Œ ä»Šæ—¥å›ºå®šæ”¯å‡ºï¼šã€Œæ°´é›»è²»ï¼å†·æ°£å„²å€¼ 150 å…ƒã€ï¼Œç³»çµ±å·²è‡ªå‹•æ‰£æ¬¾ã€‚</p>';
    }

    var allowDraw=(d===1||d===3);
    $('#drawBlock').classList.toggle('hidden',!allowDraw);

    $('#alerts').innerHTML=html;
    alertInfo(html);
    updateStuBarsAndDash();
    updateWorkButton();
    updateGiftButtonForDay();
    updateQuickLog();
  }

  // ğŸŒ™ çµæŸä»Šå¤©
  $('#endDay').onclick=function(){
    var d=S.meta.day;

    var stuEmpty = !S.tx_stu[d] || S.tx_stu[d].length===0;
    if(stuEmpty){
      alertWarn('ä»Šå¤©ä½ åœ¨ã€Œå­¸ç”Ÿè¨˜å¸³ã€å®Œå…¨æ²’æœ‰ç´€éŒ„ã€‚\næƒ³ä¸€æƒ³ï¼šçœŸçš„éƒ½æ²’æœ‰æ”¶æ”¯æˆ–é«”åŠ›ï¼å¿ƒæƒ…è®ŠåŒ–å—ï¼Ÿ\nç³»çµ±ä»æœƒç…§å¾Œå°è·‘ï¼Œçµç®—æ™‚èª¤å·®æœƒè®Šå¤§å–”ã€‚');
    }

    var st=calcSysEndState(d);
    var f={$:st.money<0,e:st.energy<=0,m:st.mood<=0};
    if(f.$||f.e||f.m){
      if(!S.deathDays)S.deathDays=[];
      if(S.deathDays.indexOf(d)===-1)S.deathDays.push(d);
      S.deathCount=(S.deathCount||0)+1;
      save();
      beep('dead');alertWarn(deathMsg(f));
    }else{
      beep('warn');alertInfo('ä»Šå¤©çµæŸï¼Œè¨˜å¾—å›é ­çœ‹ä¸€ä¸‹ä½ èŠ±äº†ä»€éº¼ã€è³ºäº†ä»€éº¼ã€‚');
    }

    if(S.meta.day<4){
      S.meta.day++;save();dayStart(false);
    }else{
      nav('#page-summary');updateSummary(true);
    }
  };

  function finalPayload(){
    var id=key().replace(PFX+':','');
    var sys=calcSysAllForPayload(),stu=calcStuUpTo(4);
    return{
      key:id,day:S.meta.day,
      system:{money:Math.round(sys.money),energy:Math.round(sys.energy),mood:Math.round(sys.mood),deaths:sys.deaths},
      student:{money:Math.round(stu.money),energy:Math.round(stu.energy),mood:Math.round(stu.mood),deaths:stu.deaths}
    };
  }

  function fillDetailTable(sel, src){
    var tb = $(sel);
    tb.innerHTML = '';
    var deathDays = S.deathDays || [];
    var markUsed = {};
    for (var d = 1; d <= 4; d++) {
      var arr = src[d] || [];
      for (var i = 0; i < arr.length; i++) {
        var t = arr[i];
        var noteText = t.note || '';
        if (deathDays.indexOf(d) !== -1 && !markUsed[d]) {
          noteText += (noteText ? 'ï½œ' : '') + 'ã€æ­¤æ—¥çµæŸå¾Œæ­»äº¡é‡ç”Ÿã€‘';
          markUsed[d] = true;
        }
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + d + '</td>' +
          '<td>' + (t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º') + '</td>' +
          '<td>' + transCat(t.cat) + '</td>' +
          '<td class="right">' + t.amt + '</td>' +
          '<td class="right">' + fmtSign(t.e) + '</td>' +
          '<td class="right">' + fmtSign(t.m) + '</td>' +
          '<td>' + noteText + '</td>';
        tb.appendChild(tr);
      }
    }
  }

  function sumDayTx(arr) {
    var m = 0, e = 0, mo = 0;
    for (var i = 0; i < arr.length; i++) {
      var t = arr[i];
      m += (t.type === 'income' ? +t.amt : -t.amt);
      e += t.e || 0;
      mo += t.m || 0;
    }
    return {money: m, energy: e, mood: mo};
  }

  function buildDailyDiffTable(){
    var tbody = document.getElementById('dailyDiffBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    for (var d = 1; d <= 4; d++) {
      var sysDay = sumDayTx(S.tx_sys[d] || []);
      var stuDay = sumDayTx(S.tx_stu[d] || []);

      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>Day ' + d + '</td>' +
        '<td class="right pair-money">' + sysDay.money + '</td>' +
        '<td class="right pair-money">' + stuDay.money + '</td>' +
        '<td class="right pair-energy">' + sysDay.energy + '</td>' +
        '<td class="right pair-energy">' + stuDay.energy + '</td>' +
        '<td class="right pair-mood">' + sysDay.mood + '</td>' +
        '<td class="right pair-mood">' + stuDay.mood + '</td>';
      tbody.appendChild(tr);
    }
  }

  function updateSummary(success){
    var sys=calcSysAllForPayload(),stu=calcStuUpTo(4);
    $('#smMoney').textContent=Math.round(sys.money);
    $('#smE').textContent=Math.round(sys.energy);
    $('#smM').textContent=Math.round(sys.mood);
    $('#smD').textContent=sys.deaths;
    $('#stMoney').textContent=Math.round(stu.money);
    $('#stE').textContent=Math.round(stu.energy);
    $('#stM').textContent=Math.round(stu.mood);
    $('#stD').textContent=stu.deaths;

    var diff=Math.abs(stu.money-sys.money);
    var msg='ä½ å’Œç³»çµ±çš„ã€Œé‡‘éŒ¢å·®è·ã€æ˜¯ï¼š$'+diff+'ã€‚';
    if(diff<=50)msg+='ğŸŸ¢ éå¸¸æ¥è¿‘ï¼Œè¨˜å¸³å¾ˆä»”ç´°ï¼';
    else if(diff<=200)msg+='ğŸŸ¡ æœ‰ä¸€é»å·®è·ï¼Œå¯èƒ½å°‘è¨˜å¹¾ç­†ã€‚';
    else msg+='ğŸ”´ å·®å¾ˆå¤šï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å¿˜è¨˜è¨˜å›ºå®šæ”¯å‡ºæˆ–äº‹ä»¶ã€‚';

    var dd=(S.deathDays||[]).slice().sort(function(a,b){return a-b;});
    var deadInfo=dd.length
      ? 'ç³»çµ±åµæ¸¬åˆ°æ­»äº¡æ—¥ï¼šDay '+dd.join('ã€')+'ã€‚'
      : 'ç³»çµ±æ²’æœ‰åµæ¸¬åˆ°æ­»äº¡äº‹ä»¶ã€‚';

    $('#delta').textContent=msg+' '+deadInfo;

    fillDetailTable('#sysTable tbody',S.tx_sys);
    fillDetailTable('#stuTable tbody',S.tx_stu);
    buildDailyDiffTable();

    if(success){
      alertSuccess('ğŸ‰ 4 å¤©æŒ‘æˆ°å®Œæˆï¼\nçœ‹çœ‹è‡ªå·±çš„è¨˜å¸³å’Œç³»çµ±å·®å¤šå°‘ï¼Œæƒ³æƒ³æ˜¯åœ¨å“ªäº›åœ°æ–¹æ¼æ‰ã€‚');
      beep('ding');setTimeout(function(){beep('ding');},200);
    }
  }

  var sumBtn=document.querySelector('.sticky [data-nav="#page-summary"]');
  sumBtn.onclick=function(){nav('#page-summary');updateSummary(false);};

  // è¡¨å–®é€äº¤
  function openForm(obj){
    if(!S.formURL){
      try{
        S.formURL = localStorage.getItem(FORMKEY) || DEFAULT_FORM;
      }catch(e){}
    }
    if(!S.formURL){
      alertWarn('è€å¸«å°šæœªè¨­å®šè¡¨å–®ç¶²å€ã€‚');
      return;
    }
    window.open(S.formURL + encodeURIComponent(JSON.stringify(obj)),'_blank');
  }
  $('#sendEnd').onclick=function(){openForm(finalPayload());};

  $('#tun').onclick=function(){
    if(($('#tpw').value||'').trim()===TEACHER){$('#tTools').classList.remove('hidden');}
    else alertError('æ•™å¸«ç¢¼éŒ¯èª¤');
  };
  $('#saveForm').onclick=function(){
    S.formURL=($('#formURL').value||'').trim();
    save();
    try{
      localStorage.setItem(FORMKEY, S.formURL);
    }catch(e){}
    $('#formSaved').textContent=S.formURL?'å·²è¨­å®š':'â€”';
  };
  $('#parse').onclick=function(){
    var tb=$('#aggT tbody');tb.innerHTML='';
    var lines=($('#agg').value||'').split(/\n+/);
    lines=lines.map(function(s){return s.trim();}).filter(function(s){return s;});
    for(var i=0;i<lines.length;i++){
      var line=lines[i];
      try{
        var j=JSON.parse(line),sys=j.system||{},stu=j.student||{};
        var tr=document.createElement('tr');
        tr.innerHTML='<td>'+j.key+'</td><td>'+(j.day||'')+'</td>'
          +'<td>'+(sys.money||'')+'</td><td>'+(stu.money||'')+'</td>'
          +'<td>'+(sys.energy||'')+'</td><td>'+(stu.energy||'')+'</td>'
          +'<td>'+(sys.mood||'')+'</td><td>'+(stu.mood||'')+'</td>'
          +'<td>'+(sys.deaths||'')+'</td><td>'+(stu.deaths||'')+'</td>';
        tb.appendChild(tr);
      }catch(e){
        var tr2=document.createElement('tr');
        tr2.innerHTML='<td colspan="10">âŒ ç„¡æ³•è§£æï¼š'+line+'</td>';
        tb.appendChild(tr2);
      }
    }
  };
  $('#csvAll').onclick=function(){
    var lines=($('#agg').value||'').split(/\n+/);
    lines=lines.map(function(s){return s.trim();}).filter(function(s){return s;});
    if(!lines.length){alertWarn('è«‹å…ˆè²¼ä¸Šä¸¦è§£æå­¸ç”Ÿ JSONã€‚');return;}
    var rows=[["student","day","sys_money","stu_money","sys_energy","stu_energy","sys_mood","stu_mood","sys_deaths","stu_deaths"]];
    for(var i=0;i<lines.length;i++){
      var line=lines[i];
      try{
        var j=JSON.parse(line),sys=j.system||{},stu=j.student||{};
        rows.push([j.key||'',j.day||'',sys.money||'',stu.money||'',sys.energy||'',stu.energy||'',sys.mood||'',stu.mood||'',sys.deaths||'',stu.deaths||'']);
      }catch(e){rows.push(["BAD:"+line]);}
    }
    var csv=rows.map(function(r){
      return r.map(function(v){var s=String(v).replace(/"/g,'""');return '"'+s+'"';}).join(',');
    }).join('\n');
    var a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    a.download='class-summary-v60.csv';a.click();
  };

  $$('.sticky [data-nav]').forEach(function(b){
    var target=b.getAttribute('data-nav');
    if(target!=='#page-summary'){
      b.onclick=function(){nav(target);};
    }
  });
  function boot(){var h=location.hash||'#page-cover';nav(h);}
  window.addEventListener('hashchange',boot);boot();

})();
</script>

</body>
</html>
